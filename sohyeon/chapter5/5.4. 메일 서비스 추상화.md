## 5.4 메일 서비스 추상화
- 레벨이 업그레이드되는 사용장게는 안내 메일을 발송해야 한다.
  - 사용자의 이메일 정보를 관리해야 한다.
  - UserService의 upgradeLevel() 메소드에 메일 발송 기능을 추가한다.
 
<br/>

### 5.4.1 JavaMail을 이용한 메일 발송 기능
- DB의 User 테이블에 email 필드를, User 클래스에 email 프로퍼티를 추가한다.

<br/>

> ***JavaMail 메일 발송***

🔽 레벨 업그레이드 작업 메소드 수정
```java
protected void upgradeLevel(User user) {
  user.upgradeLevel();
  userDao.update(user);
  sendUpgradeEMail(user);
}
```
- 메일 발송 메소드를 호출한다.

<br/>

🔽 JavaMail을 이용한 메일 발송 메소드
```java
private void sendUpgradeEMail(User user) {
  Properties props = new Properties();
  props.put("mail.smtp.host", "mail.ksug.org");
  Session s = Session.getInstance(props, null);

  MimeMessage message = new MimeMessage(s);
  try {
    message.setFrom("new InternetAddress("useradmin@ksug.org"));
    message.addRecipient(Message.RecipientType.TO, new InternetAddress(user.getEmail()));
    message.setSubject("Upgrade 안내");
    message.setText("사용자님이 등급이 " + user.getLevel().name() + "로 업그레이드되었습니다.");

    Transport.send(message);
  } catch (AddressException e) {
    throw new RuntimeException(e);
  } catch (MessagingException e) {
    throw new RuntimeException(e);
  } catch (UnsupportedEncodingException e) {
    throw new RuntimeException(e);
  }
}
```
- JavaMail API를 사용하는 메소드를 추가한다.

<br/>

### 5.4.2 JavaMail이 포함된 코드의 테스트

- 메일 발송 테스트란 엄밀히 말해서 불가능하다.
- 메일 테스트를 한다고 매번 메일 수신 여부까지 일일이 확인할 필요는 없고, 테스트 가능한 메일 서버까지만 잘 전송되는지 확인하면 된다.

<br/>

🔽 테스트 메일 서버를 이용한 테스트 구조

![image](https://github.com/Team-Sopetit/server-spring-study/assets/55437339/b3ffc922-62aa-4792-aaf8-8eeb0cde6a89)

- 실제 메일 서버를 사용하지 않고 테스트 메일 서버를 이용해 테스트하는 방법이다.
- 테스트 메일 서버는 JavaMail과 연동해서 메일 전송 요청을 받는 것까지만 담당한다.

<br/>

🔽 테스트용 JavaMail을 이용한 테스트 구조

![image](https://github.com/Team-Sopetit/server-spring-study/assets/55437339/9d2e9f74-df3a-419c-aafe-362ada228d41)

- JavaMail API를 통해 요청이 들어간다는 보장만 있으면 굳이 테스트 할 때마다 JavaMail을 직접 구동시킬 필요가 없다.
- 개발 중이거나 테스트를 수행할 때는 JavaMail을 대신할 수 있는 코드가 동작하도록 만들어도 된다.
- 매번 검증이 필요 없는 불필요한 메일 전송 요청을 보내지 않아도 되고, 테스트도 매우 빠르고 안전하게 수행될 수 있다.

<br/>

### 5.4.3 테스트를 위한 서비스 추상화
