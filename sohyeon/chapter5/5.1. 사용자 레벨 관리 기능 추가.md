## 5.1 ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€
- ì§€ê¸ˆê¹Œì§€ ë§Œë“¤ì—ˆë˜ UserDaoë¥¼ ë‹¤ìˆ˜ì˜ íšŒì›ì´ ê°€ì…í•  ìˆ˜ ìˆëŠ” ì¸í„°ë„· ì„œë¹„ìŠ¤ì˜ ì‚¬ìš©ì ê´€ë¦¬ ëª¨ë“ˆì— ì ìš©í•œë‹¤ê³  ê°€ì •í•œë‹¤.
- ì¸í„°ë„· ì„œë¹„ìŠ¤ì˜ ì‚¬ìš©ì ê´€ë¦¬ ê¸°ëŠ¥ì—ì„œ êµ¬í˜„í•´ì•¼ í•  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
  - ì‚¬ìš©ìì˜ ë ˆë²¨ì€ BASIC, SILVER, GOLD 3ê°€ì§€ ì¤‘ í•˜ë‚˜ë‹¤.
  - ì‚¬ìš©ìê°€ ì²˜ìŒ ê°€ì…í•˜ë©´ BASIC ë ˆë²¨ì´ ë˜ë©°, ì´í›„ í™œë™ì— ë”°ë¼ì„œ í•œ ë‹¨ê³„ì”© ì—…ê·¸ë ˆì´ë“œ ë  ìˆ˜ ìˆë‹¤.
  - ê°€ì… í›„ 50íšŒ ì´ìƒ ë¡œê·¸ì¸ì„ í•˜ë©´ BASICì—ì„œ SILVER ë ˆë²¨ì´ ëœë‹¤.
  - SILVER ë ˆë²¨ì´ë©´ì„œ 30ë²ˆ ì´ìƒ ì¶”ì²œì„ ë°›ìœ¼ë©´ GOLD ë ˆë²¨ì´ ëœë‹¤.
  - ì‚¬ìš©ì ë ˆë²¨ì˜ ë³€ê²½ ì‘ì—…ì€ ì¼ì •í•œ ì£¼ê¸°ë¡œ ì¼ê´„ì ìœ¼ë¡œ ì§„í–‰ëœë‹¤. ë³€ê²½ ì‘ì—… ì „ì—ëŠ” ì¡°ê±´ì„ ì¶©ì¡±í•˜ë”ë¼ë„ ë ˆë²¨ì˜ ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.

<br/>

### 5.1.1. í•„ë“œ ì¶”ê°€

> ***Level ì´ëŠ„***

ğŸ”½ ì •ìˆ˜í˜• ìƒìˆ˜ ê°’ìœ¼ë¡œ ì •ì˜í•œ ì‚¬ìš©ì ë ˆë²¨
```java
class User {
  private static final int BASIC = 1;
  private static final int SILVER = 2;
  private static final int GOLD = 3;

  int level;

  public void setLevel(int level) {
    this.level = level;
  }
}
```
ğŸ”½ ì‚¬ìš©ì ë ˆë²¨ ìƒìˆ˜ ê°’ì„ ì´ìš©í•œ ì½”ë“œ
```java
if (user1.getLevel() == User.BASIC) {
  user1.setLevel(User.SILVER);
} 
```
- ê° ë ˆë²¨ ê°’ì„ ì½”ë“œí™”í•´ì„œ **ë²”ìœ„ê°€ ì‘ì€ ìˆ«ì**ë¡œ ê´€ë¦¬í•˜ë©´ DB ìš©ëŸ‰ë„ ë§ì´ ì°¨ì§€í•˜ì§€ ì•Šê³  ê°€ë²¼ì›Œì„œ ì¢‹ë‹¤.
- BASIC, SILVER, GOLDì²˜ëŸ¼ ì˜ë¯¸ ìˆëŠ” ìƒìˆ˜ë„ ì •ì˜í•´ë†¨ìœ¼ë‹ˆ ê¹”ë”í•˜ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- DBì— ì €ì¥ë  ë•ŒëŠ” getLevel()ì´ ëŒë ¤ì£¼ëŠ” ê°’ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

<br/>

```java
user1.setLevel(other.getSum());
```
- í•˜ì§€ë§Œ levelì˜ íƒ€ì…ì´ intì´ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì •ë³´ë¥¼ ë„£ëŠ” **ì‹¤ìˆ˜ë¥¼ í•´ë„ ì»´íŒŒì¼ëŸ¬ê°€ ì²´í¬í•´ì£¼ì§€ ëª»í•œë‹¤.**

<br/>

ğŸ”½ ì‚¬ìš©ì ë ˆë²¨ìš© ì´ëŠ„
```java
package springbook.user.domain;
...
public enum Level {
  BASIC(1), SILVER(2), GOLD(3); // 3ê°œì˜ ì´ëŠ„ ì˜¤ë¸Œì íŠ¸ ì •ì˜

  private final int value;

  Level(int value) { // DBì— ì €ì¥í•  ê°’ì„ ë„£ì–´ì¤„ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ë‘”ë‹¤.
    this.value = value;
  }

  public int intValue() { // ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì†Œë“œ
    return value;
  }

  public static Level valueOf(int value) { // ê°’ìœ¼ë¡œë¶€í„° Level íƒ€ì… ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ë§Œë“  static method
    switch(value) {
      case1: return BASIC;
      case2: return SILVER;
      case3: return GOLD;
      default: throw new AssertionError("Unknown value: " + value);
    }
  }
}
```
- ìˆ«ì íƒ€ì…ì„ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ëŠ” **ì´ëŠ„(ENUM, ìë°”5 ì´ìƒì—ì„œ ì œê³µ)** ì„ ì´ìš©í•˜ëŠ” ê²Œ ì•ˆì „í•˜ê³  í¸ë¦¬í•˜ë‹¤.
- ë‚´ë¶€ì—ëŠ” DBì— ì €ì¥í•  int íƒ€ì…ì˜ ê°’ì„ ê°–ê³  ìˆì§€ë§Œ, ê²‰ìœ¼ë¡œëŠ” **Level íƒ€ì…ì˜ ì˜¤ë¸Œì íŠ¸**ì´ê¸° ë•Œë¬¸ì— **ì•ˆì „í•˜ê²Œ ì‚¬ìš©**í•  ìˆ˜ ìˆë‹¤.
- ì—†ëŠ” ì½”ë“œëŠ” ì»´íŒŒì¼ëŸ¬ê°€ íƒ€ì…ì´ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì—ëŸ¬ë¥¼ ë‚´ë©´ì„œ ê±¸ëŸ¬ì¤„ ê²ƒì´ë‹¤.

<br/>

> ***User í•„ë“œ ì¶”ê°€***


ğŸ”½ Userì— ì¶”ê°€ëœ í•„ë“œ
```java
public class User {
  ...
  Level level;
  int login;
  int recommend;

  public Level getLevel() {
    return level;
  }

  public void setLevel(Level level) {
    this.level = level;
  }
  ...
  // login, recommend getter/setter ìƒëµ
}
```

- Level íƒ€ì…ì˜ ë³€ìˆ˜ë¥¼ User í´ë˜ìŠ¤ì— ì¶”ê°€í•œë‹¤.
- (ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ë¡œì§ì—ì„œ ì–¸ê¸‰) ë¡œê·¸ì¸ íšŸìˆ˜ì™€ ì¶”ì²œ ìˆ˜ë„ ì¶”ê°€í•œë‹¤.

<br/>

> ***UserDaoTest í…ŒìŠ¤íŠ¸ ìˆ˜ì •***

ğŸ”½ ìˆ˜ì •ëœ í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜
```java
public class UserDaoTest {
  ...
  @Before
  public void setUp() {
    this.user1 = new User("sohyeon", "ê¹€ì†Œí˜„", "springno1", Level.BASIC, 1, 0);
    this.user2 = new User("seungbin", "ìµœìŠ¹ë¹ˆ", "springno2", Level.SILVER, 55, 10);
    this.user3 = new User("chan", "ë‚¨ê¶ì°¬", "springno3", Level.GOLD, 100, 40);
  }
```
- UserDaoJdbcëŠ” í…ŒìŠ¤íŠ¸ê¹Œì§€ ê°–ì¶”ê³  ìˆëŠ” ì•ˆì •ëœ ì½”ë“œë‹¤. ê¸°ì¡´ ì½”ë“œì— ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ë ¤ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ì•¼ í•œë‹¤.
- í”½ìŠ¤ì²˜ë¡œ ë§Œë“  user1, user2, user3ì— ìƒˆë¡œ ì¶”ê°€ëœ ìƒˆ í•„ë“œì˜ ê°’ì„ ë„£ëŠ”ë‹¤. (ìœ ìš©í•˜ê²Œ ì“°ê¸° ìœ„í•´ ê°ê° ë‹¤ë¥¸ ê°’ ì‚½ì…)

<br/>

ğŸ”½ ì¶”ê°€ëœ í•„ë“œë¥¼ íŒŒë¼ë¯¸í„°ë¡œ í¬í•¨í•˜ëŠ” ìƒì„±ì
```java
class User {
  ...
  public User(String id, String name, String password, Level level, int login, int recommend) {
    this.id = id;
    this.name = name;
    this.password = password;
    this.level = level;
    this.login = login;
    this.recommend = recommend;
  }
```
- ì´ì— ë§ê²Œ User í´ë˜ìŠ¤ ìƒì„±ìì˜ íŒŒë¼ë¯¸í„°ë„ ì¶”ê°€í•´ì¤€ë‹¤.

<br/>

ğŸ”½ ìƒˆë¡œìš´ í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” User í•„ë“œ ê°’ ê²€ì¦ ë©”ì†Œë“œ
```java
private void checkSameUser(User user1, User user2) {
  asssertThat(user1.getId(), is(user2.getId()));
  asssertThat(user1.getName(), is(user2.getName()));
  asssertThat(user1.getPassword(), is(user2.getPassword()));
  asssertThat(user1.getLevel(), is(user2.getLevel()));
  asssertThat(user1.getLogin(), is(user2.getLogin()));
  asssertThat(user1.getRecommend(), is(user2.getRecommend()));
}
```
- UserDaoTest í…ŒìŠ¤íŠ¸ì—ì„œ 2ê°œì˜ User ì˜¤ë¸Œì íŠ¸ í•„ë“œ ê°’ì´ ëª¨ë‘ ê°™ì€ì§€ ë¹„êµí•˜ëŠ” checkSameUser() ë©”ì†Œë“œë¥¼ ìˆ˜ì •í•œë‹¤.
- ìƒˆë¡œìš´ í•„ë“œë¥¼ ë¹„êµí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤.

<br/>

ğŸ”½ checkSameUser() ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë§Œë“  addAndGet() ë©”ì†Œë“œ
```java
@Test
public void addAndGet() {
  ...
  User userget1 = dao.get(user1.getId());
  checkSameUser(userget1, user1);

  User userget2 = dao.get(user2.getId());
  checkSameUser(userget2, user2);
}
```
- (ì•ìœ¼ë¡œ ì¶”ê°€ë˜ê±°ë‚˜ ë³€ê²½ë¼ë„ User ì˜¤ë¸Œì íŠ¸ë¥¼ **ë¹„êµí•˜ëŠ” ë¡œì§ì„ ì¼ì •í•˜ê²Œ ìœ ì§€**í•  ìˆ˜ ìˆë„ë¡) checkSameUser()ì„ ì´ìš©í•´ ìˆ˜ì •í•œë‹¤.

<br/>

> ***UserDaoJdbc ìˆ˜ì •***

ğŸ”½ ì¶”ê°€ëœ í•„ë“œë¥¼ ìœ„í•œ UserDaoJdbcì˜ ìˆ˜ì • ì½”ë“œ
```java
public class UserDaoJdbc implements UserDao {
  ...
  private RowMapper<User> userMapper =
    new RowMapper<User>() {
      public User mapRow(ResultSet rs, int rowNum) throws SQLException {
        User user = new User();
        user.setId(rs.getString("id"));
        user.setName(rs.getString("name"));
        user.setPassword(rs.getString("password"));
        user.setLevel(Level.valueOf(rs.getInt("level")));
        user.setLogin(rs.getInt("login"));
        user.setRecommend(rs.getInt("recommend"));
        return user;
      }
    };

  public void add(User user) {
    this.jdbcTemplate.update(
      "insert into users(id, name, password, level, login, recommend) " +
      "values(?,?,?,?,?,?)", user.getId(), user.getName(), user.getPassword(),
      user.getLevel().intValue(), user.getLogin(), user.getRecommend());
  }
```
- **add() ë©”ì†Œë“œì˜ SQL**ê³¼ **userMapper**(ê°ì¢… ì¡°íšŒ ì‘ì—…ì— ì‚¬ìš©ë˜ëŠ” User ì˜¤ë¸Œì íŠ¸ ë§¤í•‘ìš© ì½œë°±)ì— **ì¶”ê°€ëœ í•„ë“œ**ë¥¼ ë„£ëŠ”ë‹¤.
- Level ì´ëŠ„ì€ ì˜¤ë¸Œì íŠ¸(DBì— ì €ì¥ë  ìˆ˜ ìˆëŠ” SQL íƒ€ì…X)ì´ë¯€ë¡œ, **DBì— ì €ì¥ ê°€ëŠ¥í•œ ì •ìˆ˜í˜• ê°’ìœ¼ë¡œ ë³€í™˜**í•´ì¤˜ì•¼ í•œë‹¤.
- ë°˜ëŒ€ë¡œ **ì¡°íšŒ**í•  ê²½ìš°, ResultSetì—ì„œëŠ” **DBì˜ íƒ€ì…ì¸ intë¡œ level ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.**
- Levelì˜ valueOf() ë©”ì†Œë“œë¥¼ í†µí•´ int íƒ€ì…ì˜ ê°’ì„ Level íƒ€ì…ì˜ ì´ëŠ„ ì˜¤ë¸Œì íŠ¸ë¡œ ë§Œë“¤ì–´ì„œ setLevel() ë©”ì†Œë“œì— ë„£ì–´ì¤˜ì•¼ í•œë‹¤.

<br/>

### 5.1.2 ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€
- ê¸°ë³¸í‚¤ì¸ idë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ í•„ë“œëŠ” ìˆ˜ì •ë  ê°€ëŠ¥ì„±ì´ ìˆë‹¤.
- ìˆ˜ì •í•  ì •ë³´ê°€ ë‹´ê¸´ User ì˜¤ë¸Œì íŠ¸ë¥¼ ì „ë‹¬í•˜ë©´ idë¥¼ ì°¸ê³ í•´ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì•„ í•„ë“œ ì •ë³´ë¥¼ UPDATEë¬¸ì„ ì´ìš©í•´ ëª¨ë‘ ë³€ê²½í•´ì£¼ëŠ” ë©”ì†Œë“œë¥¼ ë§Œë“¤ì–´ë³¸ë‹¤.

> ***ìˆ˜ì • ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€***

ğŸ”½ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ë©”ì†Œë“œ í…ŒìŠ¤íŠ¸
```java
@Test
public void update() {
  dao.deleteAll();

  dao.add(user1);

  // í”½ìŠ¤ì²˜ì— ë“¤ì–´ ìˆëŠ” ì •ë³´ë¥¼ ë³€ê²½í•´ì„œ ìˆ˜ì • ë©”ì†Œë“œ í˜¸ì¶œ
  user1.setName("ê¹€ì†Œí˜„");
  user1.setPassword("springno6);
  user1.setLevel(Level.GOLD);
  user1.setLogin(1000);
  user1.setRecommend(999);
  dao.update(user1);

  User user1update = dao.get(user1.getId());
  checkSameUser(user1, user1update);
}
```
- ë¨¼ì € í”½ìŠ¤ì²˜ ì˜¤ë¸Œì íŠ¸ í•˜ë‚˜ë¥¼ ë“±ë¡í•œë‹¤.
- idë¥¼ ì œì™¸í•œ í•„ë“œì˜ ë‚´ìš©ì„ ë°”ê¾¼ ë’¤ update()ë¥¼ í˜¸ì¶œí•œë‹¤.
- ë‹¤ì‹œ idë¡œ ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¨ User ì˜¤ë¸Œì íŠ¸ì™€ ìˆ˜ì •í•œ í”½ìŠ¤ì²˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ë¹„êµí•œë‹¤.

<br/>

> ***UserDaoì™€ UserDaoJdbc ìˆ˜ì •***

ğŸ”½ update() ë©”ì†Œë“œ ì¶”ê°€
```java
public interface UserDao {
  ...
  public void update(User user1);
}
```
- ì¸í„°í˜ì´ìŠ¤ì— update() ë©”ì†Œë“œë¥¼ ì¶”ê°€í•œë‹¤.

<br/>

ğŸ”½ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •ìš© update() ë©”ì†Œë“œ
```java
public void update(User user) {
  this.jdbcTemplate.update(
    "update users set name = ?, password = ?, level = ?, login = ?, recommend = ? " +
    "where id = ? ", user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommend(), user.getId());
}
```
- UserDaoJdbcì˜ update() ë©”ì†Œë“œëŠ” JdbcTemplateì˜ **update() ê¸°ëŠ¥ì„ ì‚¬ìš©**í•´ì„œ UPDATEë¬¸ê³¼ ë°”ì¸ë”©í•  íŒŒë¼ë¯¸í„°ë¥¼ ì „ë‹¬í•œë‹¤.

<br/>

> ***ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë³´ì™„***

ìˆ˜ì •í•˜ì§€ ì•Šì•„ì•¼ í•  ë¡œìš°ì˜ ë‚´ìš©ì´ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆëŠ”ì§€ ì¶”ê°€ ê²€ì¦í•œë‹¤.
- **JdbcTemplateì˜ update()ê°€ ëŒë ¤ì£¼ëŠ” ë¦¬í„´ ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**
- update()ëŠ” í…Œì´ë¸” ë‚´ìš©ì— ì˜í–¥ì„ ì£¼ëŠ” SQLì„ ì‹¤í–‰í•˜ë©´ ì˜í–¥ë°›ì€ ë¡œìš°ì˜ ê°œìˆ˜ë¥¼ ëŒë ¤ì¤€ë‹¤.
- **í…ŒìŠ¤íŠ¸ë¥¼ ë³´ê°•í•´ì„œ ì›í•˜ëŠ” ì‚¬ìš©ì ì™¸ì˜ ì •ë³´ëŠ” ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**
- ì‚¬ìš©ìë¥¼ 2ëª… ë“±ë¡í•´ë†“ê³ , ê·¸ ì¤‘ í•˜ë‚˜ë§Œ ìˆ˜ì •í•´ì„œ ìˆ˜ì •ëœ ì‚¬ìš©ìì™€ ìˆ˜ì •ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ëª¨ë‘ í™•ì¸í•œë‹¤.

ğŸ”½ ë³´ì™„ëœ update() í…ŒìŠ¤íŠ¸
```java
@Test
public void update() {
  dao.deleteAll();

  dao.add(user1); // ìˆ˜ì •í•  ì‚¬ìš©ì
  dao.add(user2); // ìˆ˜ì •í•˜ì§€ ì•Šì„ ì‚¬ìš©ì

  user1.setName("ê¹€ì†Œí˜„");
  user1.setPassword("springno6");
  user1.setLevel(Level.GOLD);
  user1.setLogin(1000);
  user1.setRecommend(999);

  dao.update(user1);

  User user1update = dao.get(user1.getId());
  checkSameUser(user1, user1update);
  User user2same = dao.get(user2.getId());
  checkSameUser(user2, user2same);
}

```
- update() ë©”ì†Œë“œì˜ SQLì—ì„œ WHEREë¥¼ ë¹¼ë¨¹ì—ˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨í•  ê²ƒì´ë‹¤.

<br/>

### 5.1.3 UserService.upgradeLevels()

![image](https://github.com/Team-Sopetit/server-spring-study/assets/55437339/af09f7f1-681e-4838-aa4f-82adc073488c)


- ì‚¬ìš©ì ê´€ë¦¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ì„ í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ì¶”ê°€í•œë‹¤. (DAOëŠ” ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ê°€ì ¸ì˜¤ê³  ì¡°ì‘í• ì§€ë¥¼ ë‹¤ë£¨ëŠ” ê³³ì´ë¯€ë¡œ)
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•œë‹¤ëŠ” ì˜ë¯¸ì—ì„œ **í´ë˜ìŠ¤ ì´ë¦„ì€ UserService**ë¡œ í•œë‹¤.
- UserDao ì¸í„°í˜ì´ìŠ¤ íƒ€ì…ìœ¼ë¡œ ë¹ˆì„ DI ë°›ì•„ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤. (UserDaoëŠ” ì¸í„°í˜ì´ìŠ¤, userDaoëŠ” ë¹ˆ ì˜¤ë¸Œì íŠ¸ ì´ë¦„)
- UserServiceëŠ” UserDaoì˜ êµ¬í˜„ í´ë˜ìŠ¤ê°€ ë°”ë€Œì–´ë„ ì˜í–¥ë°›ì§€ ì•Šë„ë¡ í•œë‹¤. (ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©, DI ì ìš©)
- UserServiceTestëŠ” UserServiceë¥¼ ìœ„í•œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì´ë‹¤.

<br/>

> ***UserService í´ë˜ìŠ¤ì™€ ë¹ˆ ë“±ë¡***

ğŸ”½ UserService í´ë˜ìŠ¤
```java
package springbook.user.service;
...
public class UserService {
  UserDao userDao;

  public void setUserDao(UserDao userDao) {
    this.userDao = userDao;
  }
}
```

- **UserService í´ë˜ìŠ¤**ë¥¼ ë§Œë“¤ê³  **UserDao ì˜¤ë¸Œì íŠ¸**ë¥¼ ì €ì¥í•´ë‘˜ **ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜**ë¥¼ ì„ ì–¸í•œë‹¤.
- DIê°€ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •ì ë©”ì†Œë“œë„ ì¶”ê°€í•œë‹¤.

<br/>

ğŸ”½ userService ë¹ˆ ì„¤ì •
```java
<bean id="userService" class="springbook.user.service.UserService">
  <property name="userDao" ref="userDao" />
</bean>

<bean id="userDao" class="springbook.dao.UserDaoJdbc">
  <property name="dataSource" ref="dataSource" />
</bean>
```
- ìŠ¤í”„ë§ ì„¤ì •íŒŒì¼ì— userService ì•„ì´ë””ë¡œ ë¹ˆì„ ì¶”ê°€í•œë‹¤.
- userDao ë¹ˆì„ DI ë°›ë„ë¡ í”„ë¡œí¼í‹°ë¥¼ ì¶”ê°€í•œë‹¤.

<br/>

> ***UserServiceTest í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤***

ğŸ”½ UserServiceTest í´ë˜ìŠ¤
```java
package springbook.user.service;
...
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locaions="/test-applicationContext.xml")
public class UserServiceTest {
  @Autowired
  UserService userService;
}
```
- UserService(í…ŒìŠ¤íŠ¸ ëŒ€ìƒ) ë¹ˆì„ ì œê³µë°›ì„ ìˆ˜ ìˆë„ë¡ @Autowiredê°€ ë¶™ì€ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ì„ ì–¸í•´ì¤€ë‹¤.
- ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ ì£¼ì…ë°›ì„ ìˆ˜ ìˆë‹¤.

<br/>

ğŸ”½ userService ë¹ˆì˜ ì£¼ì…ì„ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸
```java
@Test
public void bean() {
  assertThat(this.userService, is(notNullValue()));
}
```
- ë¹ˆì´ ìƒì„±ë˜ê³  ë³€ìˆ˜ì— ì£¼ì…ë˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œì´ë‹¤.
- í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•˜ë©´ UserService ë¹ˆì´ ì˜ ë“±ë¡ëìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. (ì´í›„ ë³„ ì˜ë¯¸ê°€ ì—†ìœ¼ë¯€ë¡œ ì‚­ì œ)

<br/>

> ***upgradeLevels() ë©”ì†Œë“œ***

ğŸ”½ ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ë©”ì†Œë“œ
```java
public void upgradeLevels() {
  List<User> users = userDao.getAll();
  for(User user : users) {
    Boolean changed = null; // ë ˆë²¨ì˜ ë³€í™”ê°€ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

    // BASIC ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…
    if (user.getLevel() == Level.BASIC && user.getLogin() >= 50) {
      user.setLevel(Level.SILVER);
      changed = true;
    }

    // SILVER ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…
    else if (user.getLevel() == Level.SILVER && user.getRecommend() >= 30) {
      user.setLevel(Level.GOLD);
      changed = true; // ë ˆë²¨ ë³€ê²½ í”Œë˜ê·¸ ì„¤ì •
    }

    else if (user.getLevel() == Level.GOLD) {
      changed = false; // GOLD ë ˆë²¨ì€ ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.
    }

    else {
      changed = false; // ì¼ì¹˜í•˜ëŠ” ì¡°ê±´ì´ ì—†ìœ¼ë©´ ë³€ê²½ ì—†ìŒ
    }

    // ë ˆë²¨ì˜ ë³€ê²½ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ update() í˜¸ì¶œ
    if (changed) {
      userDao.upgrade(user);
    }
  }
}
```
- ëª¨ë“  ì‚¬ìš©ì ì •ë³´ë¥¼ DAOì—ì„œ ê°€ì ¸ì˜¨ í›„ì— í•œ ëª…ì”© ë ˆë²¨ ë³€ê²½ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.
- ì‚¬ìš©ì ë ˆë²¨ì´ ë³€ê²½ëëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸ë¥¼ í•˜ë‚˜ ì„ ì–¸í•œë‹¤.
- ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì„ ê²€ì‚¬í•˜ê³  ì¶©ì¡±í•˜ë©´ ë ˆë²¨ì„ ë³€ê²½í•œë‹¤. (ë³€ê²½ í”Œë˜ê·¸ì¸ changedë„ trueë¡œ ì„¤ì •)
- ë ˆë²¨ ë³€ê²½ì´ ìˆëŠ” ê²½ìš°(changed=false)ì—ë§Œ UserDaoì˜ update()ë¥¼ ì´ìš©í•´ ìˆ˜ì • ë‚´ìš©ì„ DBì— ë°˜ì˜í•œë‹¤.

<br/>

> ***upgradeLevels() í…ŒìŠ¤íŠ¸***

ğŸ”½ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“  í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜
```java
class UserServiceTest {
  ...
  List<User> users; // í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜

  @Before
  public void setUp() {
    users = Arrays.asList(
      new User("sohyeon", "ê¹€ì†Œí˜„", "p1", Level.BASIC, 49, 0),
      new User("seungbin", "ìµœìŠ¹ë¹ˆ", "p2", Level.BASIC, 50, 0),
      new User("chan", "ë‚¨ê¶ì°¬", "p3", Level.SILVER, 60, 29),
      new User("sofite", "ì†Œí”„í‹°", "p4", Level.SILVER, 60, 30),
      new User("server", "ì„œë²„", "p5", Level.GOLD, 100, 100)
    );
  }
}
```
- ì ì–´ë„ ê°€ëŠ¥í•œ ëª¨ë“  ì¡°ê±´ì„ í•˜ë‚˜ì”©ì€ í™•ì¸í•´ì•¼ í•œë‹¤.
- ì‚¬ìš©ì ë ˆë²¨(BASIC, SILVER, GOLD) 3ê°€ì§€ + ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” GOLD ì œì™¸ ë‚˜ë¨¸ì§€ 2ê°€ì§€(ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ” ê²½ìš°, ì•„ë‹Œ ê²½ìš°)
- BASICê³¼ SILVER ë ˆë²¨ì˜ ì‚¬ìš©ìëŠ” ê°ê° 2ê°œì”© ë“±ë¡í•œë‹¤. (ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ” ê²½ìš°, ì•„ë‹Œ ê²½ìš°)

<br/>

ğŸ”½ ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ í…ŒìŠ¤íŠ¸
```java
@Test
public void upgradeLevels() {
  userDao.deleteAll();
  for(User user : users) userDao.add(user);

  userService.upgradeLevels();

  // ê° ì‚¬ìš©ìë³„ë¡œ ì—…ê·¸ë ˆì´ë“œ í›„ì˜ ì˜ˆìƒ ë ˆë²¨ì„ ê²€ì¦
  checkLevel(users.get(0), Level.BASIC);
  checkLevel(users.get(1), Level.SILVER);
  checkLevel(users.get(2), Level.SILVER);
  checkLevel(users.get(3), Level.GOLD);
  checkLevel(users.get(4), Level.GOLD);
}

// DBì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ ë ˆë²¨ì„ í™•ì¸í•˜ëŠ” ì½”ë“œê°€ ì¤‘ë³µë˜ë¯€ë¡œ í—¬í¼ ë©”ì†Œë“œë¡œ ë¶„ë¦¬
private void checkLevel(User user, Level expectedLevel) {
  User userUpdate = userDao.get(user.getId());
  assertThat(userUpdate.getLevel(), is(expectedLevel));
}
```
- ë‹¤ì„¯ ì¢…ë¥˜ì˜ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•œ í›„ upgradeLevels() ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•œë‹¤.
- ì—…ê·¸ë ˆì´ë“œ ì‘ì—… í›„ ë ˆë²¨ ë³€ê²½ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.

<br/>

### 5.1.4 UserService.add()

- ì²˜ìŒ ê°€ì…í•˜ëŠ” ì‚¬ìš©ìëŠ” ê¸°ë³¸ì ìœ¼ë¡œ BASIC ë ˆë²¨ì´ì–´ì•¼ í•œë‹¤ëŠ” ë¶€ë¶„ì„ ì¶”ê°€ë¡œ êµ¬í˜„í•´ì•¼ í•œë‹¤.
- ì‚¬ìš©ì ê´€ë¦¬ì— ëŒ€í•œ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ê³  ìˆëŠ” UserService**ì— ë¡œì§ì„ ì¶”ê°€í•œë‹¤.
- UserServiceì—ë„ add()ë¥¼ ë§Œë“¤ì–´ë‘ê³  ì‚¬ìš©ìê°€ ë“±ë¡ë  ë•Œ ì ìš©ë  ë§Œí•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ê²Œ í•œë‹¤.

<br/>

ğŸ”½ add() ë©”ì†Œë“œì˜ í…ŒìŠ¤íŠ¸
```java
@Test
public void add() {
  userDao.deleteAll();

  User userWithLevel = users.get(4); // GOLD ë ˆë²¨ (ë¯¸ë¦¬ ì§€ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë ˆë²¨ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ)
  User userWithoutLevel = users.get(0); // ë ˆë²¨ì´ ë¹„ì–´ ìˆëŠ” ì‚¬ìš©ì
  userWithoutLevel.setLevel(null); // ë¡œì§ì— ë”°ë¼ ë“±ë¡ ì¤‘ì— BASIC ë ˆë²¨ë¡œ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤.

  userService.add(userWithLevel);
  userService.add(userWithoutLevel);

  // DBì— ì €ì¥ëœ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ í™•ì¸í•œë‹¤.
  User userWithLevelRead = userDao.get(userWithLevel.getId());
  User userWithoutLevelRead = userDao.get(userWithoutLevel.getId());

  assertThat(userWithLevelRead.getLevel(), is(userWithLevel.getLevel()));
  assertThat(userWithoutLevelRead.getLevel(), is(Level.BASIC));
}
```

- UserServiceì˜ add()ë¥¼ í˜¸ì¶œí•˜ë©´ ë ˆë²¨ì´ BASICìœ¼ë¡œ ì„¤ì •ë˜ëŠ” ê²ƒì„ ê²€ì¦í•œë‹¤.
- add()ë¥¼ í˜¸ì¶œí•  ë•Œ level í•„ë“œì— ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ BASICì„ ë¶€ì—¬í•´ì£¼ê³ , ë¯¸ë¦¬ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘”ë‹¤.
- ë ˆë²¨ì´ ë¯¸ë¦¬ ì •í•´ì§„ ê²½ìš°ì™€ ë ˆë²¨ì´ ë¹„ì–´ ìˆëŠ” 2ê°€ì§€ ê²½ìš°ì— ê°ê° add() ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ë„ë¡ í•œë‹¤.
- ë ˆë²¨ì´ ì´ë¯¸ ì„¤ì •ëë˜ ê²ƒì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ì–´ ìˆì–´ì•¼ í•˜ê³ , ë ˆë²¨ì´ ì—†ë˜ ê²ƒì€ ë””í´íŠ¸ì¸ BASICìœ¼ë¡œ ì„¤ì •ëëŠ”ì§€ í™•ì¸í•œë‹¤.

<br/>

ğŸ”½ ì‚¬ìš©ì ì‹ ê·œ ë“±ë¡ ë¡œì§ì„ ë‹´ì€ add() ë©”ì†Œë“œ
```java
public void add(User user) {
  if (user.getLevel() == null) user.setLevel(Level.BASIC);
  userDao.add(user);
}
```
- í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•˜ë„ë¡ í•˜ëŠ” add() ë©”ì†Œë“œ ì½”ë“œì´ë‹¤.

<br/>

### 5.1.5 ì½”ë“œ ê°œì„ 

- ì½”ë“œì— ì¤‘ë³µëœ ë¶€ë¶„ì€ ì—†ëŠ”ê°€?
- ì½”ë“œê°€ ë¬´ì—‡ì„ í•˜ëŠ” ê²ƒì¸ì§€ ì´í•´í•˜ê¸° ë¶ˆí¸í•˜ì§€ ì•Šì€ê°€?
- ì½”ë“œê°€ ìì‹ ì´ ìˆì–´ì•¼ í•  ìë¦¬ì— ìˆëŠ”ê°€?
- ì•ìœ¼ë¡œ ë³€ê²½ì´ ì¼ì–´ë‚œë‹¤ë©´ ì–´ë–¤ ê²ƒì´ ìˆì„ ìˆ˜ ìˆê³ , ê·¸ ë³€í™”ì— ì‰½ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆê²Œ ì‘ì„±ë˜ì–´ ìˆëŠ”ê°€?

<br/>

> ***upgradeLevels() ë©”ì†Œë“œ ì½”ë“œì˜ ë¬¸ì œì ***

- for ë£¨í”„ ì†ì— ë“¤ì–´ ìˆëŠ” if/elseif/else ë¸”ë¡ë“¤ì´ ì½ê¸° ë¶ˆí¸í•˜ë‹¤.
- if ì¡°ê±´ ë¸”ë¡ì´ ë ˆë²¨ ê°œìˆ˜ë§Œí¼ ë°˜ë³µëœë‹¤.
- í˜„ì¬ ë ˆë²¨ê³¼ ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì„ ë™ì‹œì— ë¹„êµí•˜ëŠ” ë¶€ë¶„ë„ ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤. (ì„±ê²©ì´ ë‹¤ë¥¸ 2ê°€ì§€ ê²½ìš°ê°€ ëª¨ë‘ í•œ ê³³ì—ì„œ ì²˜ë¦¬ë˜ëŠ” ê²ƒì€ ì´ìƒí•¨)

<br/>

> ***upgradeLevels() ë¦¬íŒ©í† ë§***

ğŸ”½ ê¸°ë³¸ ì‘ì—… íë¦„ë§Œ ë‚¨ê²¨ë‘” upgradeLevels()
```java
public void upgradeLevels() {
  List<User> users = userDao.getAll();
  for(User user : users) {
    if (canUpgradeLevel(user)) {
      upgradeLevel(user);
    }
  }
}
```
- ë ˆë²¨ì„ ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” ì‘ì—…ì˜ ê¸°ë³¸ íë¦„ë§Œ ë¨¼ì € ë§Œë“¤ì–´ë³¸ë‹¤.
- êµ¬ì²´ì ì¸ êµ¬í˜„ì—ì„œ ì™¸ë¶€ì— ë…¸ì¶œí•  ì¸í„°í˜ì´ìŠ¤ë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•œ ì‘ì—…ì´ë‹¤.
- ëª¨ë“  ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ í•œ ëª…ì”© ì—…ê·¸ë ˆì´ë“œê°€ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê³ , ê°€ëŠ¥í•˜ë©´ ì—…ê·¸ë ˆì´ë“œë¥¼ í•œë‹¤.

<br/>

ğŸ”½ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥ í™•ì¸ ë©”ì†Œë“œ
```java
private boolean canUpgradeLevel(User user) {
  Level currentLevel = user.getLevel();
  switch(currentLevel) { // ë ˆë²¨ë³„ë¡œ êµ¬ë¶„í•´ì„œ ì¡°ê±´ì„ íŒë‹¨í•œë‹¤.
    case BASIC: return (user.getLogin() >= 50);
    case SILVER: return (user.getRecommend() >= 30);
    case GOLD: return false;
    default: throw new IllegalArgumentException("Unknown Level: " + currentLevel); // í˜„ì¬ ë¡œì§ì—ì„œ ë‹¤ë£° ìˆ˜ ì—†ëŠ” ë ˆë²¨ì´ ì£¼ì–´ì§€ë©´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤. ìƒˆë¡œìš´ ë ˆë²¨ì´ ì¶”ê°€ë˜ê³  ë¡œì§ì„ ìˆ˜ì •í•˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ê°€ ë‚˜ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
  } 
}
```
- ì—…ê·¸ë ˆì´ë“œê°€ ê°€ëŠ¥í•œì§€ë¥¼ ì•Œë ¤ì£¼ëŠ” ë©”ì†Œë“œì´ë‹¤.
- ì£¼ì–´ì§„ userì— ëŒ€í•´ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•˜ë©´ true, ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ falseë¥¼ ë¦¬í„´í•œë‹¤.
- ìƒíƒœì— ë”°ë¼ì„œ ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ë§Œ ë¹„êµí•˜ë©´ ë˜ë¯€ë¡œ, ì—­í• ê³¼ ì±…ì„ì´ ëª…ë£Œí•˜ë‹¤.
- switchë¬¸ìœ¼ë¡œ ë ˆë²¨ì„ êµ¬ë¶„í•˜ê³ , ê° ë ˆë²¨ì— ëŒ€í•œ ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
- ë¡œì§ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ë ˆë²¨ì¸ ê²½ìš° ì˜ˆì™¸ë¥¼ ë˜ì ¸ì¤€ë‹¤.

<br/>

ğŸ”½ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—… ë©”ì†Œë“œ
```java
private void upgradeLevel(User user) {
  if (user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
  else if (user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD);
  userDao.update(user);
}
```
- ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì„ ë§Œì¡±í–ˆì„ ê²½ìš° **êµ¬ì²´ì ìœ¼ë¡œ ë¬´ì—‡ì„ í•  ê²ƒì¸ê°€**ë¥¼ ë‹´ê³  ìˆëŠ” ë©”ì†Œë“œì´ë‹¤.
- ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œë¥¼ ìœ„í•œ ì‘ì—…ì€ ì‚¬ìš©ì ë ˆë²¨ì„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒê³¼ ë³€ê²½ì‚¬í•­ì„ DBì— ì—…ë°ì´íŠ¸í•´ì£¼ëŠ” ê²ƒì´ë‹¤.
- ë©”ì†Œë“œë¥¼ ë”°ë¡œ ë¶„ë¦¬í•´ë‘ë©´ ë‚˜ì¤‘ì— ì‘ì—… ë‚´ìš©ì´ ì¶”ê°€ë˜ë”ë¼ë„ ì–´ëŠ ê³³ì„ ìˆ˜ì •í•´ì•¼ í• ì§€ê°€ ëª…í™•í•´ì§„ë‹¤.
- ì‚¬ìš©ì ì˜¤ë¸Œì íŠ¸ì˜ ë ˆë²¨ì •ë³´ë¥¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë³€ê²½í•˜ê³ , ë³€ê²½ëœ ì˜¤ë¸Œì íŠ¸ë¥¼ DBì— ì—…ë°ì´íŠ¸í•œë‹¤.
- í•˜ì§€ë§Œ ë‹¤ìŒ ë‹¨ê³„ê°€ ë¬´ì—‡ì¸ê°€ í•˜ëŠ” ë¡œì§ê³¼ ê·¸ë•Œ ì‚¬ìš©ì ì˜¤ë¸Œì íŠ¸ì˜ level í•„ë“œë¥¼ ë³€ê²½í•´ì¤€ë‹¤ëŠ” ë¡œì§ì´ í•¨ê»˜ ìˆê³ , ë„ˆë¬´ ë…¸ê³¨ì ì´ë‹¤.
- ì˜ˆì™¸ìƒí™©ì— ëŒ€í•œ ì²˜ë¦¬ê°€ ì—†ëŠ” ê²ƒë„ ê³¤ë€í•˜ë‹¤.

<br/>

ğŸ”½ ì—…ê·¸ë ˆì´ë“œ ìˆœì„œë¥¼ ë‹´ê³  ìˆë„ë¡ ìˆ˜ì •í•œ Level
```java
public enum Level {
  // ì´ëŠ„ ì„ ì–¸ì— DBì— ì €ì¥í•  ê°’ê³¼ í•¨ê»˜ ë‹¤ìŒ ë‹¨ê³„ì˜ ë ˆë²¨ ì •ë³´ë„ ì¶”ê°€í•œë‹¤.
  GOLD(3, null), SILVER(2, GOLD), BASIC(1, SILVER);

  private final int value;
  private final Level next; // ë‹¤ìŒ ë‹¨ê³„ì˜ ë ˆë²¨ ì •ë³´ë¥¼ ìŠ¤ìŠ¤ë¡œ ê°–ê³  ìˆë„ë¡ Level íƒ€ì…ì˜ next ë³€ìˆ˜ë¥¼ ì¶”ê°€í•œë‹¤.

  Level(int value, Level next) {
    this.value = value;
    this.next = next;
  }

  public int intValue() {
    return value;
  }

  public Level nextLevel() {
    return this.next;
  }

  public static Level valueOf(int value) {
    switch(value) {
      case 1: return BASIC;
      case 2: return SILVER;
      case 3: return GOLD;
      default: throw new AssertionError("Unknown value: " + value);
    }
  }
}
```
- ë ˆë²¨ì˜ ìˆœì„œì™€ ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ë¥¼ ê²°ì •í•˜ëŠ” ì¼ì€ Levelì—ê²Œ ë§¡ê¸´ë‹¤. (ë ˆë²¨ì˜ ìˆœì„œë¥¼ êµ³ì´ UserServiceì— ë‹´ì•„ë‘˜ ì´ìœ  X)
- nextë¼ëŠ” ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ ì •ë³´ë¥¼ ë‹´ì„ ìˆ˜ ìˆë„ë¡ í•„ë“œë¥¼ ì¶”ê°€í•œë‹¤.
- ìƒì„±ì íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•´ì„œ ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ ì •ë³´ë¥¼ ì§€ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
- ë‹¤ìŒ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ ì•Œê³  ì‹¶ë‹¤ë©´ nextLevel() ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•´ì£¼ë©´ ëœë‹¤.

<br/>

ğŸ”½ Userì˜ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ìš© ë©”ì†Œë“œ
```java
public void upgradeLevel() {
  Level nextLevel = this.levelnextLevel();
  if (nextLevel == null) {
    throw new IllegalStateException(this.level + "ì€ ì—…ê·¸ë ˆì´ë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤");
  }
  else {
    this.level = nextLevel;
  }
}
```

- ì‚¬ìš©ì ì •ë³´ê°€ ë°”ë€ŒëŠ” ë¶€ë¶„ì„ UserService ë©”ì†Œë“œì—ì„œ Userë¡œ ì˜®ê¸´ë‹¤.
- Userì˜ ë‚´ë¶€ ì •ë³´ê°€ ë³€ê²½ë˜ëŠ” ê²ƒì€ Userê°€ ìŠ¤ìŠ¤ë¡œ ë‹¤ë£¨ëŠ” ê²ƒì´ ì ì ˆí•˜ë‹¤.
- ë¨¼ì € Levelì˜ nextLevel() ê¸°ëŠ¥ì„ í†µí•´ í˜„ì¬ ë ˆë²¨ì˜ ë‹¤ìŒ ë‹¨ê³„ê°€ ë¬´ì—‡ì¸ì§€ í™•ì¸í•œë‹¤.
- ì—…ê·¸ë ˆì´ë“œê°€ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°, User ì˜¤ë¸Œì íŠ¸ë¥¼ UserServiceë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì•„ë‹ˆë¯€ë¡œ **ìŠ¤ìŠ¤ë¡œ ì˜ˆì™¸ìƒí™©ì— ëŒ€í•œ ê²€ì¦ ê¸°ëŠ¥ì„ ê°–ê³  ìˆëŠ” í¸ì´ ì•ˆì „**í•˜ë‹¤.

<br/>

ğŸ”½ ê°„ê²°í•´ì§„ upgradeLevel()
```java
private void upgradeLevel(User user) {
  user.upgradeLevel();
  userDao.update(user);
}
```
- UserServiceëŠ” User ì˜¤ë¸Œì íŠ¸ì—ê²Œ ì•Œì•„ì„œ ì—…ê·¸ë ˆì´ë“œì— í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë¼ê³  ìš”ì²­ë§Œ í•´ì£¼ë©´ ë˜ê¸° ë•Œë¬¸ì— ì½”ë“œê°€ ê°„ê²°í•´ì§„ë‹¤.
- if ë¬¸ì¥ì´ ë§ì´ ë“¤ì–´ìˆë˜ ì´ì „ ì½”ë“œë³´ë‹¤ **ê°„ê²°í•˜ê³  ì‘ì—… ë‚´ìš©ì´ ëª…í™•í•˜ê²Œ** ë“œëŸ¬ë‚œë‹¤.

<br/>

- ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì‘ì—…í•˜ëŠ” ëŒ€ì‹  **ë°ì´í„°ë¥¼ ê°–ê³  ìˆëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ì—ê²Œ ì‘ì—…ì„ í•´ë‹¬ë¼ê³  ìš”ì²­**í•œë‹¤.
- ì˜¤ë¸Œì íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ìš”êµ¬í•˜ì§€ ë§ê³  **ì‘ì—…ì„ ìš”ì²­í•˜ë¼**ëŠ” ê²ƒì´ ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì˜ ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” ì›ë¦¬ì´ë‹¤.
- UserServiceëŠ” Userì—ê²Œ "ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ì„ í•´ë‹¬ë¼"ê³  ìš”ì²­í•˜ê³ , ë˜ UserëŠ” Levelì—ê²Œ "ë‹¤ìŒ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ ì•Œë ¤ë‹¬ë¼"ê³  ìš”ì²­í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì´ë‹¤.

<br/>

> ***User í…ŒìŠ¤íŠ¸***

ğŸ”½ User í…ŒìŠ¤íŠ¸
```java
package springbook.user.service;
...
public class UserTest {
  User user;

  @Before
  public void setUp() {
    user = new User();
  }

  @Test()
  public void upgradeLevel() {
    Level[] levels = Level.values();
    for(Level level : levels) {
      if (level.nextLevel() == null) continue;
      user.setLevel(level);
      user.upgradeLevel();
      assertThat(user.getLevel(), is(level.nextLevel()));
    }
  }

  @Test(expected=IllegalStatementException.class)
  public void cannotUpgradeLevel() {
    Level[] levels = Level.values();
    for(Level level : levels) {
      if (level.nextLevel() != null) continue;
      user.setLevel(level);
      user.upgradeLevel();
    }
  }
}
```
- Userì— ì¶”ê°€í•œ upgradeLevel() ë©”ì†Œë“œì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ì´ë‹¤.
- User ì˜¤ë¸Œì íŠ¸ëŠ” ìŠ¤í”„ë§ì´ IoCë¡œ ê´€ë¦¬í•´ì£¼ëŠ” ì˜¤ë¸Œì íŠ¸ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì—, ìŠ¤í”„ë§ì˜ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
- ë”°ë¼ì„œ @Autowiredë¡œ ê°€ì ¸ì˜¤ëŠ” ëŒ€ì‹  ìƒì„±ìë¥¼ í˜¸ì¶œí•´ì„œ í…ŒìŠ¤íŠ¸í•  User ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“¤ë©´ ëœë‹¤.
- Level ì´ëŠ„ì— ì •ì˜ëœ ëª¨ë“  ë ˆë²¨ì„ ê°€ì ¸ì™€ì„œ Userì— ì„¤ì •í•´ë‘ê³  Userì˜ upgradeLevel()ì„ ì‹¤í–‰í•´ì„œ ë‹¤ìŒ ë ˆë²¨ë¡œ ë°”ë€ŒëŠ”ì§€ í™•ì¸í•œë‹¤.
- ë” ì´ìƒ ì—…ê·¸ë ˆì´ë“œí•  ë ˆë²¨ì´ ì—†ëŠ” ê²½ìš° upgradeLevel()ì„ í˜¸ì¶œí•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ì§€ë„ í™•ì¸í•œë‹¤.

<br/>

> ***UserServiceTest ê°œì„ ***

ğŸ”½ ê°œì„ í•œ upgradeLevels() í…ŒìŠ¤íŠ¸
```java
@Test
public void upgradeLevels() {
  userDao.deleteAll();
  for(User user : users) userDao.add(user);

  userService.upgradeLevels();

  checkLevelUpgrade(users.get(0), false);
  checkLevelUpgrade(users.get(1), true);
  checkLevelUpgrade(users.get(2), false);
  checkLevelUpgrade(users.get(3), true);
  checkLevelUpgrade(users.get(4), false);
}

private void checkLevelUpgrade(User user, boolean upgraded) { // ì–´ë–¤ ë ˆë²¨ë¡œ ë°”ë€” ê²ƒì¸ê°€ê°€ ì•„ë‹ˆë¼, ë‹¤ìŒ ë ˆë²¨ë¡œ ì—…ê·¸ë ˆì´ë“œ ë  ê²ƒì¸ê°€ ì•„ë‹Œê°€ë¥¼ ì§€ì •í•œë‹¤.
  User userUpdate = userDao.get(user.getId());
  if (upgraded) {
    assertThat(userUpdate.getLevel(), is(user.getLevel().nextLevel())); // ì—…ê·¸ë ˆì´ë“œê°€ ì¼ì–´ë‚¬ëŠ”ì§€ í™•ì¸, ë‹¤ìŒ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ëŠ” Levelì—ê²Œ ë¬¼ì–´ë³´ë©´ ëœë‹¤.
  }
  else {
    assertThat(userUpdate.getLevel(), is(user.getLevel())); // ì—…ê·¸ë ˆì´ë“œê°€ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
  }
}
```
- ê° ì‚¬ìš©ìì— ëŒ€í•´ ì—…ê·¸ë ˆì´ë“œë¥¼ í™•ì¸í•˜ë ¤ëŠ” ê²ƒì¸ì§€ ì•„ë‹Œì§€ê°€ ì¢€ ë” ì´í•´í•˜ê¸° ì‰½ê²Œ true, falseë¡œ ë‚˜íƒ€ë‚˜ ìˆì–´ì„œ ë³´ê¸° ì¢‹ë‹¤.
- ì—…ê·¸ë ˆì´ë“œëì„ ë•Œ ì–´ë–¤ ë ˆë²¨ì¸ì§€ëŠ” Level ì´ëŠ„ì˜ nextLevel()ì„ í˜¸ì¶œí•´ë³´ë©´ ëœë‹¤.

<br/>

ğŸ”½ ìƒìˆ˜ì˜ ë„ì…
```java
public static final int MIN_LOGCOUNT_FOR_SILVER = 50;
public static final int MIN_RECOMMEND_FOR_GOLD = 30;

private boolean canUpgradeLevel(User user) {
  Level currentLevel = user.getLevel();
  switch(currentLevel) {
    case BASIC: return (user.getLogin() >= MIN_LOGCOUNT_FOR_SILVER);
    case SILVER: return (user.getRecommend() >= MIN_RECOMMEND_FOR_GOLD);
    case GOLD: return false;
    default: throw new IllegalArgumentException("Unknown Level: " + currentLevel);
  }
}
```

ğŸ”½ ìƒìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë§Œë“  í…ŒìŠ¤íŠ¸
```java
import static springbook.user.service.UserService.MIN_LOGCOUNT_FOR_SILVER;
import static springbook.user.service.UserService.MIN_RECOMMEND_FOR_GOLD;
...

@Before
public void setUp() {
  users = Arrays.asList(
      new User("sohyeon", "ê¹€ì†Œí˜„", "p1", Level.BASIC, MIN_LOGCOUNT_FOR_SILVER - 1, 0), // í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ê°€ëŠ¥í•œ í•œ ê²½ê³„ ê°’ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
      new User("seungbin", "ìµœìŠ¹ë¹ˆ", "p2", Level.BASIC, MIN_LOGCOUNT_FOR_SILVER, 0),
      new User("chan", "ë‚¨ê¶ì°¬", "p3", Level.SILVER, 60, MIN_RECOMMEND_FOR_GOLD - 1),
      new User("sofite", "ì†Œí”„í‹°", "p4", Level.SILVER, 60, MIN_RECOMMEND_FOR_GOLD),
      new User("server", "ì„œë²„", "p5", Level.GOLD, 100, Integer.MAX_VALUE)
    );
}
```
- ì½”ë“œì— ë‚˜íƒ€ë‚œ ì¤‘ë³µì„ ì œê±°í•œë‹¤. (ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ì¸ ë¡œê·¸ì¸ íšŸìˆ˜ì™€ ì¶”ì²œ íšŸìˆ˜ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì™€ í…ŒìŠ¤íŠ¸ ì½”ë“œì— ì¤‘ë³µë¼ì„œ ë‚˜íƒ€ë‚œë‹¤.)
- í•œ ê°€ì§€ ë³€ê²½ ì´ìœ ê°€ ë°œìƒí–ˆì„ ë•Œ ì—¬ëŸ¬ êµ°ë°ë¥¼ ê³ ì¹˜ê²Œ ë§Œë“ ë‹¤ë©´ ì¤‘ë³µì´ë‹¤.
- ë¬´ìŠ¨ ì˜ë„ë¡œ ì–´ë–¤ ê°’ì„ ë„£ì—ˆëŠ”ì§€ ì´í•´í•˜ê¸° ì‰¬ì›Œì§„ë‹¤.
- ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ ê°’ì´ ë°”ë€ŒëŠ” ê²½ìš° UserServiceì˜ ìƒìˆ˜ ê°’ë§Œ ë³€ê²½í•´ì£¼ë©´ ëœë‹¤.

<br/>

ğŸ”½ ì—…ê·¸ë ˆì´ë“œ ì •ì±… ì¸í„°í˜ì´ìŠ¤
```java
public interface UserLevelUpgradePolicy {
  boolean canUpgradeLevel(User user);
  void upgradeLevel(User user);
}
```
- ë ˆë²¨ì„ ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” ì •ì±…ì„ ìœ ì—°í•˜ê²Œ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ ê°œì„ í•œë‹¤.
- ì‚¬ìš©ì ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ UserServiceì—ì„œ ë¶„ë¦¬í•˜ëŠ” ë°©ë²•ì„ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆë‹¤.
- ë¶„ë¦¬ëœ ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ ë‹´ì€ ì˜¤ë¸Œì íŠ¸ëŠ” DIë¥¼ í†µí•´ UserServiceì— ì£¼ì…í•œë‹¤.
- ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ ë‹´ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ë‘ê³  UserServiceëŠ” DIë¡œ ì œê³µë°›ì€ ì •ì±… êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
