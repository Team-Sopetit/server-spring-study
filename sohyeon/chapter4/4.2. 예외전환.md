## 4.2 예외 전환

### 4.2.1 JDBC의 한계
- DB 종류에 상관없이 사용할 수 있는 데이터 액세스 코드를 작성하는 것은 쉽지 않다.
- 표준화된 JDBC API가 DB 프로그램 개발 방법을 학습하는 부담은 줄여주지만, DB를 자유롭게 변경해서 사용할 수 있는 유연한 코드는 보장하지 못한다.

> ***비표준 SQL***

- 첫번째 문제는 JDBC 코드에서 사용하는 SQL이다.
- 비표준 특정 DB 문법은 매우 폭넓게 사용되고 있다. (특히 DB 최적화)
- 결국 DAO를 DB별로 만들어 사용하거나 SQL을 외부에서 독립시켜 바꿔 쓸 수 있도록 한다.

<br/>

> ***호환성 없는 SQLException의 DB 에러정보***

- 두번째 문제는 SQLException이다.
- DB마다 SQL만 다른 것이 아니라 에러의 종류와 원인도 제각각인데, JDBC는 데이터 처리 중 발생하는 예외를 SQLException 하나에 모두 담는다.
- 예외가 발생한 원인은 SQLException 안의 에러 코드와 SQL 상태정보를 조회해야 하는데, DB 에러 코드는 DB별로 모두 다르다.
- DB가 MySQL에서 SQLServer로 바뀐다면 에러 코드도 달라지므로 기존의 코드는 동작하지 못할 것이다.
- SQLException은 예외가 발생했을 때의 DB 상태를 담은 SQL 상태정보를 부가적으로 제공한다.
- 하지만 DB의 JDBC 드라이버에서 SQLException을 담을 상태 코드를 정확하게 만들어주지 않는다.
- 결국 호환성 없는 에러 코드와 표준을 잘 따르지 않는 상태 코드를 가진 SQLException 만으로 DB에 독립적인 유연한 코드를 작성하긴 힘들다.

<br/>

## 4.2.2 DB 에러 코드 매핑을 통한 전환
- SQLException의 비표준 에러 코드와 SQL 상태정보에 대한 해결책
- DB별 에러 코드를 참고해서 발생한 예외의 원인이 무엇인지 해석해주는 기능을 만든다.
- DB 종류에 상관없이 동일한 상황에서 일관된 예외를 전달받을 수 있다면 효과적인 대응이 가능하다.
- 스프링은 데이터 액세스 작업 중에 발생할 수 있는 예외상황을 수십 가지 예외로 분류하고 이를 추상화해 정의한 다양한 예외 클래스를 제공한다.
- 스프링은 DB별 에러 코드를 분류해서 스프링이 정의한 예외 클래스와 매핑해놓은 에러 코드 매핑정보 테이블을 만들어두고 사용한다.

<br/>

🔽 오라클 에러 코드 매핑 파일
```xml
<bean id="Oracle" class="org.springframework.jdbc.support.SQLErrorCodes">
  <property name = "badSqlGrammerCodes"> # 예외 클래스 종류
    <value>900,903,904,917,936,942,17006</value>
  </property>
  <property name = "invalidResultSetAccessCodes">
    <value>17003</value>
  </property>
  <property name = "duplicateKeyCodes">
    <value>1</value>
  </property>
  <property name = "dataIntegityViolationCodes">
    <value>1400,1722,2291,2292</value>
  </property>
  <property name = "dataAccessResourceFailureCodes">
    <value>17002,17447</value>
  </property>
```
- SQLException을 런타임 예외로 포장하는 것이 아니라, 에러 코드를 계층 구조의 클래스 중 하나로 매핑한다.
- 전환되는 예외는 모두 서브클래스 타입이다.
- DB 종류를 확인하고 미리 준비된 매핑정보를 참고해서 적절한 예외 클래스를 선택하므로 DB가 달라져도 같은 종류의 에러라면 동일한 예외를 받을 수 있다.

<br/>

🔽 JdbcTemplate이 제공하는 예외 전환 기능을 이용하는 add() 메소드
```java
public void add() throws DuplicateKeyException {
  // JdbcTemplate을 이용해 User를 add 하는 코드
}
```
- JdbcTemplate은 SQLException을 DataAccessException 계층 구조의 예외로 포장해주기 때문에 포장을 위한 별도의 코드가 따로 필요 없다.
- DB의 종류와 상관없이 중복 키로 인해 발생하는 에러는 DataAccessException의 서브클래스인 DuplicateKeyException으로 매핑돼서 던져진다.
- DB를 변경하더라도 동일한 예외가 던져지는 것이 보장된다.

<br/>

🔽 중복 키 예외의 전환
```java
public void add() throws DuplicateUserIdException { // 애플리케이션 레벨의 체크 예외
  try {
    // jdbcTemplate을 이용해 User를 add 하는 코드
  } catch(DuplicateKeyException e) {
    // 로그를 남기는 등의 필요한 작업
    throw new DuplicateUserIdException(e); // 예외를 전환할 때는 원인이 되는 예외를 중첩하는 것이 좋다.
  }
}
```
- 중복키 에러가 발생했을 때 애플리케이션에서 직접 정의한 예외를 발생시킨다.
- 스프링의 DuplicateKeyException 예외를 전환해주는 코드를 추가했다.

<br/>

- JDBC 4.0 이후 SQLException을 세분화해서, 세분화된 예외를 사용하도록 만들었다.
- 하지만 SQLExcpeiton의 서브클래스이므로 여전히 체크 예외라는 점과 그 에외를 세분화하는 기준이 SQL 상태정보를 이용한다는 점에서 문제가 있다.
- 아직은 스프링의 에러 코드 매핑을 통한 DataAccessException 방식을 사용하는 것이 이상적이다.

<br/>

### 4.2.3 DAO 인터페이스와 DataAccessException 계층구조
