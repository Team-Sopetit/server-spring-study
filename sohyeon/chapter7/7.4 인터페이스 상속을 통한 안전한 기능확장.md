# 7.4 μΈν„°νμ΄μ¤ μƒμ†μ„ ν†µν• μ•μ „ν• κΈ°λ¥ν™•μ¥
- μ• ν”λ¦¬μΌ€μ΄μ…μ„ μƒλ΅ μ‹μ‘ν•μ§€ μ•κ³  νΉμ • SQLμ λ‚΄μ©λ§μ„ λ³€κ²½ν•κ³  μ‹¶λ‹¤λ©΄ μ–΄λ–»κ² ν•΄μ•Ό ν• κΉ?

<br/>

## 7.4.1 DIμ™€ κΈ°λ¥μ ν™•μ¥
- DIμ κ°€μΉλ¥Ό μ λ€λ΅ μ–»μΌλ ¤λ©΄ λ¨Όμ € DIμ— μ ν•©ν• μ¤λΈμ νΈ μ„¤κ³„κ°€ ν•„μ”ν•λ‹¤.

<br/>

### DIλ¥Ό μμ‹ν•λ” μ„¤κ³„
- μµμ†ν• 2κ° μ΄μƒμ, μμ΅΄κ΄€κ³„λ¥Ό κ°€μ§€κ³  μ„λ΅ ν‘λ ¥ν•΄μ„ μΌν•λ” μ¤λΈμ νΈκ°€ ν•„μ”ν•λ‹¤.
- ν•­μƒ ν™•μ¥μ„ μ—Όλ‘μ— λ‘κ³  μ¤λΈμ νΈ μ‚¬μ΄μ κ΄€κ³„λ¥Ό μƒκ°ν•΄μ•Ό ν•λ‹¤.
- DIλ€ κ²°κµ­ λ―Έλλ¥Ό ν”„λ΅κ·Έλλ°ν•λ” κ²ƒμ΄λ‹¤.

<br/>

### DIμ™€ μΈν„°νμ΄μ¤ ν”„λ΅κ·Έλλ°
- DIλ¥Ό DIλ‹µκ² λ§λ“¤λ ¤λ©΄ 2κ°μ μ¤λΈμ νΈκ°€ μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ λμ¨ν•κ² μ—°κ²°λΌμ•Ό ν•λ‹¤.
  - λ‹¤ν•μ„±μ„ μ–»μ„ μ μλ‹¤.
  - μΈν„°νμ΄μ¤ λ¶„λ¦¬ μ›μΉ™μ„ ν†µν•΄ ν΄λΌμ΄μ–ΈνΈμ™€ μμ΅΄ μ¤λΈμ νΈ μ‚¬μ΄μ κ΄€κ³„λ¥Ό λ…ν™•ν•κ² ν•΄μ¤„ μ μλ‹¤.
- μΈν„°νμ΄μ¤λ¥Ό ν΄λΌμ΄μ–ΈνΈμ μΆ…λ¥μ— λ”°λΌ μ μ ν•κ² λ¶„λ¦¬ν•΄μ„ μ¤λΈμ νΈκ°€ κµ¬ν„ν•κ² ν•λ©΄ λ§¤μ° μ μ©ν•λ‹¤.
  <img width="450" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/97377932-07b5-4ff6-ae74-4f62486597f3">

<br/>

## 7.4.2 μΈν„°νμ΄μ¤ μƒμ†

<img width="579" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/d0305005-dc41-4a65-8826-3b3380efe798">

π”Ό μΈν„°νμ΄μ¤μ™€ DIλ¥Ό ν†µν• μ μ—°ν• ν™•μ¥κµ¬μ΅°
- BaseSqlServiceλ” μΈν„°νμ΄μ¤(SqlRegistry)λ¥Ό ν†µν•΄ MySqlRegistryμ— μ ‘κ·Όν•κΈ° λ•λ¬Έμ— κµ¬ν„μ²΄μ κΈ°λ¥μ΄ ν™•μ¥λμ–΄λ„ BaseSqlService ν΄λμ¤λ” λ³€κ²½ μ—†μ΄ μ μ§€λ  μ μλ‹¤.
- MySqlRegistryλ” λ λ‹¤λ¥Έ μ  3μ ν΄λΌμ΄μ–ΈνΈλ¥Ό μ„ν• μΈν„°νμ΄μ¤λ¥Ό κ°€μ§ μ μλ‹¤.

<br/>

```java
public interface SqlRegistry {
	void registerSql(String key, String sql); // μƒλ΅μ΄ SQL λ“±λ΅
	String findSql(String key) throws SqlNotFoundException; // λ“±λ΅λ SQL κ²€μƒ‰
}
```
π”Ό SqlRegistry μΈν„°νμ΄μ¤
- μ΄λ―Έ μ μ©ν• SqlRegistryλ” κ±΄λ“λ¦¬λ©΄ μ•λλ‹¤.
- μƒλ΅μ΄ μΈν„°νμ΄μ¤λ¥Ό μ •μν•κ±°λ‚ κΈ°μ΅΄ μΈν„°νμ΄μ¤λ¥Ό ν™•μ¥ν•λ” κ² λ°”λμ§ν•λ‹¤.

<br/>

```java
public interface UpdatableSqlRegistry extends SqlRegistry {
	void updateSql(String key, String sql) throws SqlUpdatableFailureException;
	void updateSql(Map<String, String> sqlmap) throws SqlUpdatableFailureException;
}
```
π”Ό SQL μμ • κΈ°λ¥μ„ κ°€μ§„ ν™•μ¥ μΈν„°νμ΄μ¤
- SQL μ—…λ°μ΄νΈλ¥Ό μ„ν• κΈ°λ¥μ΄ μ¶”κ°€λλ‹¤.
- SQL μ—…λ°μ΄νΈ μ‘μ—…μ΄ ν•„μ”ν• μƒλ΅μ΄ ν΄λΌμ΄μ–ΈνΈ μ¤λΈμ νΈλ” UpdatableSqlRegistry μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ SQL λ μ§€μ¤νΈλ¦¬ μ¤λΈμ νΈμ— μ ‘κ·Όν•λ„λ΅ λ§λ“¤μ–΄μ•Ό ν•λ‹¤.

<br/>

<img width="542" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/9a52e98a-b2f0-40f2-9e2d-04f9a2ff45d7">

π”Ό μΈν„°νμ΄μ¤ μƒμ†μ„ μ΄μ©ν• ν™•μ¥κµ¬μ΅°
- SQL λ³€κ²½ μ”μ²­μ„ λ‹΄λ‹Ήν•λ” SQL κ΄€λ¦¬μ© μ¤λΈμ νΈ SqlAdminService

<br/>

<img width="625" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/4ec18fb0-cb03-4424-84f8-22ba9a3aebb3">

π”Ό MyUpdatableSqlRegistryμ μμ΅΄κ΄€κ³„
- BaseSqlServiceμ™€ SqlAdminService μ¤λΈμ νΈλ” λ™μΌν• MyUpdatableSqlRegistry μ¤λΈμ νΈλ¥Ό DI λ°›μ•„ μ‚¬μ©ν•λ‹¤.
- μμ΅΄κ΄€κ³„λ” DIλ¥Ό ν†µν•΄ λ™μΌν• μ¤λΈμ νΈμ— μμ΅΄ν•κ³  μμ§€λ§, μ„¤κ³„μ™€ μ½”λ“μ—μ„λ” κ°κ° λ‹¤λ¥Έ μΈν„°νμ΄μ¤μ— μμ΅΄ν•κ³  μλ‹¤.

<br/>

```java
public class SqlAdminService implements AdminEventListner {
	private UpdatableSqlRegistry updatableSqlRegistry;
	
	public void setUpdatableSqlRegistry(UpdatableSqlRegistry updatableSqlRegistry) {
		this.updatableSqlRegistry = updatableSqlRegistry;
	}
	
	public void updateEventListener(UpdateEvent event) {
		this.updatableSqlRegistry.updateSql(event.get(KEY_ID), event.get(SQL_ID));
	}
	
	...
}
```
π”Ό SqlAdminService ν΄λμ¤
- μ¤‘μ”ν• κ²ƒμ€ ν΄λΌμ΄μ–ΈνΈκ°€ μ •λ§ ν•„μ”ν• κΈ°λ¥μ„ κ°€μ§„ μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ μ¤λΈμ νΈμ— μ ‘κ·Όν•λ„λ΅ λ§λ“¤μ—λ”κ°€μ΄λ‹¤.
