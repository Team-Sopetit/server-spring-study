# 7.2 ì¸í„°í˜ì´ìŠ¤ì˜ ë¶„ë¦¬ì™€ ìê¸°ì°¸ì¡° ë¹ˆ
- SqlService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ ë°©ë²•ì„ ê³ ë¯¼í•´ë³¸ë‹¤.
- êµ¬í˜„ ë°©ë²•ê³¼ í™•ì¥ ê°€ëŠ¥ì„±ì— ë”°ë¼ ìœ ì—°í•œ ë°©ë²•ìœ¼ë¡œ ì¬êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„í•  í•„ìš”ê°€ ìˆë‹¤.

<br/>

## 7.2.1 XML íŒŒì¼ ë§¤í•‘
- SQLì„ ì €ì¥í•´ë‘ëŠ” ì „ìš© í¬ë§·ì„ ê°€ì§„ ë…ë¦½ì ì¸ íŒŒì¼ì„ ì´ìš©í•˜ëŠ” í¸ì´ ë°”ëŒì§í•˜ë‹¤.

<br/>

### JAXB
- XML ë¬¸ì„œì •ë³´ë¥¼ ê±°ì˜ ë™ì¼í•œ êµ¬ì¡°ì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ì§ì ‘ ë§¤í•‘í•´ì¤€ë‹¤.
- ë§¤í•‘í•  ì˜¤ë¸Œì íŠ¸ì˜ í´ë˜ìŠ¤ê¹Œì§€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì»´íŒŒì¼ëŸ¬ë„ ì œê³µí•œë‹¤.

<br/>

<img width="550" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/a302b338-5d15-4ce1-bb3f-c1e78853d16d">

ğŸ”¼ JAXB ë™ì‘ë°©ì‹

<br/>

### SQL ë§µì„ ìœ„í•œ ìŠ¤í‚¤ë§ˆ ì‘ì„±ê³¼ ì»´íŒŒì¼

```xml
<sqlmap>
	<sql key="userAdd">insert into users(id, name, password, email, level, login, recommend) values (?,?,?,?,?,?,?)</sql>
	<sql key="userGet">select * from users where id = ?</sql>
	...
</sqlmap>
```
ğŸ”¼ SQL ë§µ XML ë¬¸ì„œ
- í‚¤ì™€ SQL ì •ë³´ë¥¼ ë‹´ì€ <sql> íƒœê·¸ë¥¼ ê°€ì§„ XML ë¬¸ì„œë¥¼ ë§Œë“ ë‹¤.

<br/>

<img width="550" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/26fc0a21-212c-4757-887d-f9b909f4f0e4">

<img width="550" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/dd982a4b-934c-456e-ad8a-0bd5a3d1602a">

ğŸ”¼ SQL ë§µ ë¬¸ì„œì— ëŒ€í•œ ìŠ¤í‚¤ë§ˆ
- XML ë¬¸ì„œ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ê³  ìˆëŠ” XML ìŠ¤í‚¤ë§ˆì´ë‹¤.

<br/>

```
xjc -p com.example.tobyspringexperience.sql.jaxb sqlmap.xsd -d src
```
ğŸ”¼ ì»´íŒŒì¼
- `com.example.tobyspringexperience.sql.jaxb` : ìƒì„±í•  í´ë˜ìŠ¤ì˜ íŒ¨í‚¤ì§€ ì§€ì •
- `sqlmap.xsd` : ë³€í™˜í•  ìŠ¤í‚¤ë§ˆ íŒŒì¼
- `src` : ìƒì„±ëœ íŒŒì¼ì´ ì €ì¥ë  ìœ„ì¹˜ë¡œ, ì†ŒìŠ¤ í´ë”ì— ì¶”ê°€í•´ì¤€ë‹¤.
- ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´ 2ê°œì˜ ë°”ì¸ë”©ìš© ìë°” í´ë˜ìŠ¤ì™€ íŒ©í† ë¦¬ í´ë˜ìŠ¤ê°€ ë§Œë“¤ì–´ì§„ë‹¤.

<br/>

```java
// ë³€í™˜ ì‘ì—…ì—ì„œ ì°¸ê³ í•  ì •ë³´ë¥¼ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê°–ê³  ìˆë‹¤.
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "sqlmapType", propOrder = { "sql" })
@XmlRootElement(name = "sqlmap")
public class Sqlmap {

	@XmlElement(required = true)
	protected List<SqlType> sql; // <sql> íƒœê·¸ì˜ ì •ë³´ë¥¼ ë‹´ì€ SqlType ì˜¤ë¸Œì íŠ¸ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ê°–ê³  ìˆë‹¤.
	
	public List<SqlType> getSql() {
		if (Objects.isNull(sql)) {
			sql = new ArrayList<>();
		}
		return this.sql;
	}
}
```
ğŸ”¼ SqlmapType í´ë˜ìŠ¤
- <sqlmap>ì´ ë°”ì¸ë”©ë  í´ë˜ìŠ¤ì´ë‹¤.

<br/>

```java
@Getter
@Setter
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "sqlmapType", propOrder = { "value" })
public class SqlType { // <sql> íƒœê·¸ í•œ ê°œë‹¹ SqlType ì˜¤ë¸Œì íŠ¸ê°€ í•˜ë‚˜ì”© ë§Œë“¤ì–´ì§„ë‹¤.
	
	@XmlValue
	protected String value; // SQL ê°’ì„ ì €ì¥í•  ìŠ¤íŠ¸ë¦½ íƒ€ì…ì˜ í•„ë“œ
	
	@XmlAttribute(required = true)
	protected String key; // key ì• íŠ¸ë¦¬ë·°íŠ¸ì— ë‹´ê¸´ ê²€ìƒ‰ìš© í‚¤ ê°’ì„ ìœ„í•œ ìŠ¤íŠ¸ë§ íƒ€ì…ì˜ í•„ë“œ
}
```
ğŸ”¼ SqlType í´ë˜ìŠ¤
- <sql> íƒœê·¸ì˜ ì •ë³´ë¥¼ ë‹´ì„ í´ë˜ìŠ¤ì´ë‹¤.

<br/>

### ì–¸ë§ˆìƒ¬ë§
- í•™ìŠµ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³¸ë‹¤.
- ì–¸ë§ˆìƒ¬ë§: XML ë¬¸ì„œë¥¼ ì½ì–´ì„œ ìë°”ì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ë³€í™˜ë˜ëŠ” ê²ƒ
- ë§ˆìƒ¬ë§: ë°”ì¸ë”© ì˜¤ë¸Œì íŠ¸ë¥¼ XML ë¬¸ì„œë¡œ ë³€í™˜í•˜ëŠ” ê²ƒ

<br/>

<img width="493" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/5536df8e-19b4-467f-9fc4-c9bab1426858">

ğŸ”¼ í…ŒìŠ¤íŠ¸ìš© SQL ë§µ XML ë¬¸ì„œ

<br/>

```java
public class JaxbTest {
	
	@Test
	public void readSqlmap() throws JAXBException, IOException {
		String contextPath = Sqlmap.class.getPackage().getName();
		JAXBContext context = JAXBContext.newInstance(contextPath); // ë°”ì¸ë”©ìš© í´ë˜ìŠ¤ë“¤ ìœ„ì¹˜ë¥¼ ê°€ì§€ê³  JAXB ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤.
		Unmarshaller unmarshaller = context.createUnmarshaller(); // ì–¸ë§ˆìƒ¬ëŸ¬ ìƒì„±
		
		Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal( // ì–¸ë§ˆìƒ¬ì„ í•˜ë©´ ë§¤í•‘ëœ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ì˜ ë£¨íŠ¸ì¸ Sqlmapì„ ëŒë ¤ì¤€ë‹¤.
				getClass().getResourceAsStream("sqlmap.xml") // í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì™€ ê°™ì€ í´ë”ì— ìˆëŠ” XML íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤.
		);

		List<SqlType> sqlList = sqlmap.getSql();
		
		// Listì— ë‹´ê²¨ ìˆëŠ” Sql ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì™€ XML ë¬¸ì„œì™€ ê°™ì€ ì •ë³´ë¥¼ ê°–ê³  ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
		assertThat(sqlList.size(), is(3));
		assertThat(sqlList.get(0).getKey(), is("add"));
		assertThat(sqlList.get(0).getValue(), is("insert"));
		assertThat(sqlList.get(1).getKey(), is("get"));
		assertThat(sqlList.get(1).getValue(), is("select"));
		assertThat(sqlList.get(2).getKey(), is("delete"));
		assertThat(sqlList.get(2).getValue(), is("delete"));
	}
}
```
ğŸ”¼ JAXB í•™ìŠµ í…ŒìŠ¤íŠ¸

<br/>

## 7.2.2 XML íŒŒì¼ì„ ì´ìš©í•˜ëŠ” SQL ì„œë¹„ìŠ¤
- sqlServiceì— ì ìš©í•´ë³´ì.

<br/>

### SQL ë§µ XML íŒŒì¼
```xml
â€¹?xml versoin="1.0" encodinq="UTF-8"?>
<sqlmap xmlns="http://www.epril.com/sqlmap" 
        xmlns="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.epril.com/sqlmap http://www.epril.com/sqlmap/sqlap.xsd">
    <sqlmap>
        <sql key="userAdd">insert into users(id, name, password, email, level, login, recommend) values (?,?,?,?,?,?,?)</sql>
        <sql key="userGet">select * from users where id = ?</sql>
        <sql key="userGetAll">select * from users order by id</sql>
        <sql key="userDeleteAll">delete from users</sql>
        <sql key="userGetCount">select count(*) from users</sql>
        <sql key="userUpdate">update users set name = ?, password = ?, email = ?, level = ?, login = ?, recommend = ? where id = ?</sql>
    </sqlmap>
</sqlmap>
```
ğŸ”¼ SQL ë§µ XML ë¬¸ì„œ
- SQLì€ DAO ë¡œì§ì˜ ì¼ë¶€ë¼ê³  ë³¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ DAOì™€ ê°™ì€ íŒ¨í‚¤ì§€ì— ë‘ëŠ” ê²Œ ì¢‹ë‹¤.

<br/>

### XML SQL ì„œë¹„ìŠ¤
- SqlService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ë³¸ë‹¤.
- ê°€ëŠ¥í•œ í•œ XML íŒŒì¼ì€ í•œ ë²ˆë§Œ ì½ë„ë¡ í•´ì•¼ í•œë‹¤.

<br/>

```java
public class XmlSqlService implements SqlService {
	
	private Map<String, String> sqlMap = new HashMap<String, String>(); // ì½ì–´ì˜¨ SQLì„ ì €ì¥í•´ë‘˜ ë§µ
	
	// ìŠ¤í”„ë§ì´ ì˜¤ë¸Œì íŠ¸ë¥¼ ë§Œë“œëŠ” ì‹œì ì—ì„œ SQLì„ ì½ì–´ì˜¤ë„ë¡ ìƒì„±ìë¥¼ ì´ìš©í•œë‹¤.
	public XmlSqlService() {
		// JAXB APIë¥¼ ì´ìš©í•´ XML ë¬¸ì„œë¥¼ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ë¡œ ì½ì–´ì˜¨ë‹¤.
		String contextPath = Sqlmap.class.getPackage().getName();
		try {
			JAXBContext context = JAXBContext.newInstance(contextPath);
			Unmarshaller unmarshaller = context.createUnmarshaller();
			InputStream is = UserDao.class.getResourceAsStream("sqlmap.xml"); // UserDaoì™€ ê°™ì€ í´ë˜ìŠ¤íŒ¨ìŠ¤ì˜ sqlmap.xml íŒŒì¼ì„ ë³€í™˜í•œë‹¤.
			Sqlmap sqlmap = (Sqlmap)unmarshaller.unmarshal(is);
			
			// ì½ì–´ì˜¨ SQLì„ ë§µìœ¼ë¡œ ì €ì¥í•´ë‘”ë‹¤.
			for (SqlType sql : sqlmap.getSql()) {
				sqlMap.put(sql.getKey(), sql.getValue());
			}
		} catch (JAXBException e) {
			throw new RuntimeException(e); // ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì˜ˆì™¸ì´ë¯€ë¡œ ë¶ˆí•„ìš”í•œ throwsë¥¼ í”¼í•˜ë„ë¡ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ í¬ì¥í•´ì„œ ë˜ì§„ë‹¤.
		}
	}
	
	@Override
	public String getSql(String key) throws SqlRetrievalFailureException {
		String sql = sqlMap.get(key);
		if (Objects.isNull(sql)) {
			throw new SqlRetrievalFailureException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		} else {
			return sql;
		}
	}
}
```
ğŸ”¼ ìƒì„±ì ì´ˆê¸°í™” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” XmlSqlService í´ë˜ìŠ¤
- DAO ìš”ì²­ì— ë”°ë¼ SQLì„ ì°¾ì•„ì„œ ì „ë‹¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ SqlServiceë¥¼ êµ¬í˜„í–ˆë‹¤.

<br/>

```xml
<bean id="sqlService" class="com.example.tobyspringexperience.sql.service.XmlSqlService">
</bean>
```
ğŸ”¼ sqlService ì„¤ì • ë³€ê²½

<br/>

> ***ê²°ê³¼***

- ğŸŒ• ê¹”ë”í•œ XML ë¬¸ì„œì´ë¯€ë¡œ ì‘ì„±í•˜ê³  ê²€ì¦í•˜ê¸°ì— í¸ë¦¬í•˜ë‹¤.
- ğŸŒ• í•„ìš”í•˜ë‹¤ë©´ ë‹¤ë¥¸ íˆ´ì—ì„œë„ ë¶ˆëŸ¬ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ğŸŒ• SQL ë¦¬ë·°ë‚˜ íŠœë‹ì´ í•„ìš”í•˜ë‹¤ë©´ sqlmap.xml íŒŒì¼ë§Œ ì œê³µí•´ì£¼ë©´ ëœë‹¤.
- ğŸŒ• SQL ë‚´ìš©ì„ ë³€ê²½í•˜ë”ë¼ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì½”ë“œë‚˜ DI ì„¤ì •ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

<br/>

