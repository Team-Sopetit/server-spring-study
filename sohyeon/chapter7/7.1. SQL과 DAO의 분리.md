# 7.1 SQLê³¼ DAOì˜ ë¶„ë¦¬
- SQLì„ DAOì—ì„œ ë¶„ë¦¬í•´ë³´ì.
- ì‘ì—… ì¤‘ DBì˜ í…Œì´ë¸”, í•„ë“œ ì´ë¦„ê³¼ SQL ë¬¸ì¥ì€ ì–¸ì œë“ ì§€ ë°”ë€” ìˆ˜ ìˆë‹¤.
- ê·¸ë•Œë§ˆë‹¤ DAO ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ì´ë¥¼ ë‹¤ì‹œ ì»´íŒŒì¼í•´ì„œ ì ìš©í•˜ëŠ” ê±´ ìœ„í—˜í•˜ë‹¤.
- ë”°ë¼ì„œ SQLì„ ì ì ˆíˆ ë¶„ë¦¬í•´ DAO ì½”ë“œì™€ ë‹¤ë¥¸ íŒŒì¼ì´ë‚˜ ìœ„ì¹˜ì— ë‘ê³  ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤ë©´ ì¢‹ì„ ê²ƒì´ë‹¤.

<br/>

## 7.1.1 XML ì„¤ì •ì„ ì´ìš©í•œ ë¶„ë¦¬
- SQLì„ ìŠ¤í”„ë§ì˜ XML ì„¤ì •íŒŒì¼ë¡œ ë¹¼ë‹Œë‹¤.
- ì„¤ì •íŒŒì¼ì— ìˆëŠ” SQLì„ ì½”ë“œì™€ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.

<br/>

### ê°œë³„ SQL í”„ë¡œí¼í‹° ë°©ì‹
- UserDaoJdbc í´ë˜ìŠ¤ì˜ SQL 6ê°œë¥¼ í”„ë¡œí¼í‹°ë¡œ ë§Œë“¤ê³  ì´ë¥¼ XMLì—ì„œ ì§€ì •í•˜ë„ë¡ í•œë‹¤.

<br/>

```java
public class UserDaoJdbc implements UserDao {
	
	private String sqlAdd;

	public void setSqlAdd(String sqlAdd) {
		this.sqlAdd = sqlAdd;
	}
```
ğŸ”¼ add() ë©”ì„œë“œë¥¼ ìœ„í•œ SQL í•„ë“œ
- add() ë©”ì„œë“œì—ì„œ ì‚¬ìš©í•  SQLì„ í”„ë¡œí¼í‹°ë¡œ ì •ì˜í•œë‹¤.

<br/>

```java
public void add(User user) {
  this.jdbcTemplate.update(
    this.sqlAdd,
    user.getId(),
    user.getName(),
    user.getPassword(),
    user.getEmail(),
    user.getLevel().getValue(),
    user.getLogin(),
    user.getRecommend()
  );
}
```
ğŸ”¼ ì£¼ì…ë°›ì€ SQL ì‚¬ìš©
- add() ë©”ì„œë“œì˜ SQL ë¬¸ì¥ì„ ì œê±°í•˜ê³  ì™¸ë¶€ë¡œë¶€í„° DI ë°›ì€ SQL ë¬¸ì¥ì„ ë‹´ì€ sqlAddë¥¼ ì‚¬ìš©í•˜ê²Œ í•œë‹¤.

<br/>

```xml
<bean id="userDao" class="com.example.tobyspringexperience.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource"/>
    <property name="sqlAdd"
              value="insert into users(id, name, password, email, level, login, recommend) values(?,?,?,?,?,?,?)"/>
    ...
</bean>
```
ğŸ”¼ ì„¤ì •íŒŒì¼ì— ë„£ì€ SQL ë¬¸ì¥
- userDao ë¹ˆì— sqlAdd í”„ë¡œí¼í‹°ë¥¼ ì¶”ê°€í•˜ê³  SQLì„ ë„£ì–´ì¤€ë‹¤.

<br/>

> ***ì •ë¦¬***

- ğŸŒ• ì´ì œ ì‚¬ìš©í•  SQLì€ XML ì„¤ì •ì„ ë°”ê¾¸ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ììœ ë¡­ê²Œ ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë‹¤.
- ğŸŒ‘ ë§¤ë²ˆ ìƒˆë¡œìš´ SQLì´ í•„ìš”í•  ë•Œë§ˆë‹¤ í”„ë¡œí¼í‹°ë¥¼ ì¶”ê°€í•˜ê³  DIë¥¼ ìœ„í•œ ë³€ìˆ˜ì™€ ìˆ˜ì •ì ë©”ì„œë“œë„ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤.

<br/>

### SQL ë§µ í”„ë¡œí¼í‹° ë°©ì‹
- SQLì„ í•˜ë‚˜ì˜ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë‹´ì•„ë‘ëŠ” ë°©ë²•ì„ ì‹œë„í•´ë³¸ë‹¤.
- ë§µì„ ì´ìš©í•˜ë©´ í‚¤ ê°’ì„ ì´ìš©í•´ SQL ë¬¸ì¥ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- í”„ë¡œí¼í‹°ëŠ” í•˜ë‚˜ë§Œ ë§Œë“¤ì–´ë„ ë˜ê¸° ë•Œë¬¸ì— DAO ì½”ë“œëŠ” ë” ê°„ê²°í•´ì§„ë‹¤.

<br/>

```java
public class UserDaoJdbc implements UserDao {
  ...
	private Map<String, String> sqlMap;
	
	public void setSqlMap(Map<String, String> sqlMap) {
		this.sqlMap = sqlMap;
	}
```
ğŸ”¼ ë§µ íƒ€ì…ì˜ SQL ì •ë³´ í”„ë¡œí¼í‹°
- ê¸°ì¡´ SQLì„ ìœ„í•œ í”„ë¡œí¼í‹°ë¥¼ ì œê±°í•˜ê³ , Map íƒ€ì…ì˜ sqlMap í”„ë¡œí¼í‹°ë¥¼ ëŒ€ì‹  ì¶”ê°€í•œë‹¤.

<br/>

```java
public void add(User user) {
    this.jdbcTemplate.update(
        this.sqlMap.get("add"), // í”„ë¡œí¼í‹°ë¡œ ì œê³µë°›ì€ ë§µìœ¼ë¡œë¶€í„° í‚¤ë¥¼ ì´ìš©í•´ì„œ í•„ìš”í•œ SQLì„ ê°€ì ¸ì˜¨ë‹¤.
        user.getId(),
        user.getName(),
        user.getPassword(),
        user.getEmail(),
        user.getLevel().getValue(),
        user.getLogin(),
        user.getRecommend()
    );
}
```
ğŸ”¼ sqlMapì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•œ add()
- ê° ë©”ì„œë“œëŠ” ë¯¸ë¦¬ ì •í•´ì§„ í‚¤ ê°’ì„ ì´ìš©í•´ sqlMapìœ¼ë¡œë¶€í„° SQLì„ ê°€ì ¸ì™€ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤.
- í‚¤ ê°’ì€ ê°„ë‹¨í•˜ê²Œ ë©”ì„œë“œ ì´ë¦„ì„ ê·¸ëŒ€ë¡œ ë”°ë¥´ê¸°ë¡œ í•œë‹¤.

<br/>

```xml
<bean id="userDao" class="com.example.tobyspringexperience.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource"/>
    <property name="sqlMap">
        <map>
            <entry key="add" value="insert into users(id, name, password, email, level, login, recommend) values (?,?,?,?,?,?,?)" />
            <entry key="get" value="select * from users where id = ?" />
            <entry key="getAll" value="select * from users order by id" />
            <entry key="deleteAll" value="delete from users" />
            <entry key="getCount" value="select count(*) from users" />
            <entry key="update" value="update users set name = ?, password = ?, email = ?, level = ?, login = ?, recommend = ? where id = ?" />
        </map>
    </property>
</bean>
```
ğŸ”¼ ë§µì„ ì´ìš©í•œ SQL ì„¤ì •
- Mapì€ <map> íƒœê·¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- <entry> íƒœê·¸ì— ì„ ì–¸ëœ í‚¤ì™€ ê°’ì„ ë‹´ì€ Map íƒ€ì… ì˜¤ë¸Œì íŠ¸ê°€ ë§Œë“¤ì–´ì ¸ í”„ë¡œí¼í‹°ì— ì£¼ì…ëœë‹¤.

<br/>

> ***ì •ë¦¬***

- ğŸŒ• ìƒˆë¡œìš´ SQLì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ <entry> ì„¤ì •ë§Œ ì¶”ê°€í•´ì£¼ë©´ ë˜ê¸° ë•Œë¬¸ì— **ì‘ì—…ëŸ‰ë„ ì¤„ê³  ì½”ë“œë„ ê°„ë‹¨**í•´ì§„ë‹¤. <br/>
- ğŸŒ‘ ì˜¤íƒ€ì™€ ê°™ì€ ì‹¤ìˆ˜ê°€ ìˆì–´ë„ í•´ë‹¹ ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ê¸° ì „ê¹Œì§€ **ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê¸° í˜ë“¤ë‹¤.**
  - DAO ì½”ë“œì— ëŒ€í•œ í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ë¯¸ë¦¬ ê²€ì¦í•  í•„ìš”ê°€ ìˆë‹¤.

<br/>

## 7.1.2 SQL ì œê³µ ì„œë¹„ìŠ¤
- DAOê°€ ì‚¬ìš©í•  SQLì„ ì œê³µí•´ì£¼ëŠ” ê¸°ëŠ¥ì„ ë…ë¦½ì‹œí‚¬ í•„ìš”ê°€ ìˆë‹¤.
- ìœ ì—°í•˜ê³  í™•ì¥ì„±ì´ ë›°ì–´ë‚œ SQL ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë³´ì.

<br/>

### SQL ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤
- SQL ì„œë¹„ìŠ¤ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì„¤ê³„í•œë‹¤.
- SQLì— ëŒ€í•œ í‚¤ ê°’ì„ ì „ë‹¬í•˜ë©´ ê·¸ì— í•´ë‹¹í•˜ëŠ” SQLì„ ëŒë ¤ì¤€ë‹¤.

<br/>

```java
public interface SqlService {
	String getSql(String key) throws SqlRetrievalFailureException; // ëŸ°íƒ€ì„ ì˜ˆì™¸ì´ë¯€ë¡œ íŠ¹ë³„íˆ ë³µêµ¬í•´ì•¼ í•  í•„ìš”ê°€ ì—†ë‹¤ë©´ ë¬´ì‹œ ê°€ëŠ¥í•˜ë‹¤.
}
```
ğŸ”¼ sqlService ì¸í„°í˜ì´ìŠ¤
- ì£¼ì–´ì§„ í‚¤ë¥¼ ê°€ì§€ê³  SQLì„ ê°€ì ¸ì˜¤ë‹¤ê°€ ì–´ë–¤ ì´ìœ ì—ì„œë“  ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ì—ëŠ” SQLRecoverableException ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
- í•´ë‹¹ ì˜ˆì™¸ëŠ” ë³µêµ¬ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ì •ì˜í•œë‹¤.

<br/>

```java
public class SqlRetrievalFailureException extends RuntimeException {

	public SqlRetrievalFailureException(String message) {
		super(message);
	}

	public SqlRetrievalFailureException(String message, Throwable cause) {
		super(message, cause);
	}
}
```
ğŸ”¼ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸
- ë©”ì‹œì§€ì™€ ì›ì¸ì´ ë˜ëŠ” ì˜ˆì™¸ë¥¼ ë‹´ì„ ìˆ˜ ìˆëŠ” SqlRetrievalFailureException í´ë˜ìŠ¤ë¥¼ ì •ì˜í•œë‹¤.
- `Throwable` : SQLì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í•œ ê·¼ë³¸ ì›ì¸ì„ ë‹´ì„ ìˆ˜ ìˆë„ë¡ ì¤‘ì²© ì˜ˆì™¸ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ìƒì„±ìë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

<br/>

```java
public class UserDaoJdbc implements UserDao {
	...
	private SqlService sqlService;
	
	public void setSqlService(SqlService sqlService) {
		this.sqlService = sqlService;
	}
```
ğŸ”¼ sqlService í”„ë¡œí¼í‹° ì¶”ê°€
- sqlService ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ í•„ìš”í•œ SQLì„ ê°€ì ¸ì™€ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•œë‹¤.
- sqlService íƒ€ì…ì˜ ë¹ˆì„ DI ë°›ì„ ìˆ˜ ìˆë„ë¡ í”„ë¡œí¼í‹°ë¥¼ ì •ì˜í•œë‹¤.

<br/>

```java
@Override
public void add(User user) {
	this.jdbcTemplate.update(
		this.sqlService.getSql("userAdd"),
		user.getId(),
		user.getName(),
		user.getPassword(),
		user.getEmail(),
		user.getLevel().getValue(),
		user.getLogin(),
		user.getRecommend()
	);
}

@Override
public User get(String id) {
	return this.jdbcTemplate.queryForObject(
		this.sqlService.getSql("userGet"),
		this.userMapper,
		id
	);
}

@Override
public List<User> getAll() {
	return this.jdbcTemplate.query(
		this.sqlService.getSql("userGetAll"),
		this.userMapper
	);
}

@Override
public void deleteAll() {
	this.jdbcTemplate.update(this.sqlService.getSql("userDeleteAll"));
}

@Override
public int getCount() {
	Integer count = this.jdbcTemplate.queryForObject(this.sqlService.getSql("userGetCount"), Integer.class);
	return Objects.nonNull(count) ? count : 0;
}

@Override
public void update(User user) {
	this.jdbcTemplate.update(
		this.sqlService.getSql("userUpdate"),
		user.getName(),
		user.getPassword(),
		user.getEmail(),
		user.getLevel().getValue(),
		user.getLogin(),
		user.getRecommend(),
		user.getId()
	);
}
```
ğŸ”¼ sqlServiceë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•œ ë©”ì„œë“œ
- ëª¨ë“  DAOì—ì„œ ì„œë¹„ìŠ¤ ë¹ˆì„ ì´ìš©í•  ìˆ˜ ìˆë„ë¡, í‚¤ ì´ë¦„ì´ DAOë³„ë¡œ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ í•œë‹¤.
- DAOë‚˜ ì˜¤ë¸Œì íŠ¸ì˜ ì´ë¦„ì„ í•¨ê»˜ ì‚¬ìš©í•´ì„œ í‚¤ë¥¼ ì‘ì„±í•œë‹¤.

<br/>

### ìŠ¤í”„ë§ ì„¤ì •ì„ ì‚¬ìš©í•˜ëŠ” ë‹¨ìˆœ SQL ì„œë¹„ìŠ¤
- í‚¤ì™€ SQLì„ ì—”íŠ¸ë¦¬ë¡œ ê°–ëŠ” ë§µì„ ë¹ˆ ì„¤ì •ì— ë„£ì—ˆë˜ ë°©ë²•ì„ ê·¸ëŒ€ë¡œ ì ìš©í•œë‹¤.

<br/>

```java
public class SimpleSqlService implements SqlService {

	// ì„¤ì •íŒŒì¼ì— <map>ë¡œ ì •ì˜ëœ SQL ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í”„ë¡œí¼í‹°ë¡œ ë“±ë¡í•´ë‘”ë‹¤.
	private Map<String, String> sqlMap;
	
	public void setSqlMap(Map<String, String> sqlMap) {
		this.sqlMap = sqlMap;
	}
	
	@Override
	public String getSql(String key) throws SqlRetrievalFailureException {
		String sql = sqlMap.get(key); // ë‚´ë¶€ sqlMapì—ì„œ SQLì„ ê°€ì ¸ì˜¨ë‹¤.
		if (Objects.isNull(sql)) {
			// ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜ëœ ê·œì•½ëŒ€ë¡œ SQLì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í•˜ë©´ ì˜ˆì™¸ë¥¼ ë˜ì§€ë„ë¡ í•œë‹¤.
			throw new SqlRetrievalFailureException(key + "ì— ëŒ€í•œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		} else {
			return sql;
		}
	}
}
```
ğŸ”¼ ë§µì„ ì´ìš©í•œ SqlServiceì˜ êµ¬í˜„
- ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“ ë‹¤.
- Map íƒ€ì… í”„ë¡œí¼í‹°ë¥¼ ì¶”ê°€í•œë‹¤.
- ë§µì—ì„œ SQLì„ ì½ì–´ì„œ ëŒë ¤ì£¼ë„ë¡ SqlServiceì˜ getSql() ë©”ì„œë“œë¥¼ êµ¬í˜„í•œë‹¤.

<br/>

```xml
<bean id="userDao" class="com.example.tobyspringexperience.user.dao.UserDaoJdbc">
	<property name="dataSource" ref="dataSource"/>
	<property name="sqlService" ref="sqlService" />
</bean>

<bean id="sqlService" class="com.example.tobyspringexperience.sql.SimpleSqlService">
	<property name="sqlMap">
		<map>
			<entry key="add" value="insert into users(id, name, password, email, level, login, recommend) values (?,?,?,?,?,?,?)" />
			<entry key="get" value="select * from users where id = ?" />
			<entry key="getAll" value="select * from users order by id" />
			<entry key="deleteAll" value="delete from users" />
			<entry key="getCount" value="select count(*) from users" />
			<entry key="update" value="update users set name = ?, password = ?, email = ?, level = ?, login = ?, recommend = ? where id = ?" />
		</map>
	</property>
</bean>
```
- SimpleSqlService í´ë˜ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³  UserDaoê°€ DI ë°›ì•„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•´ì¤€ë‹¤.
- SQL ì •ë³´ëŠ” ì´ ë¹ˆì˜ í”„ë¡œí¼í‹°ì— <map>ì„ ì´ìš©í•´ ë“±ë¡í•œë‹¤.

<br/>

> ***ìš”ì•½***

- ğŸŒ• DAOëŠ” SQLì„ ì–´ë””ì— ì €ì¥í•´ë‘ê³  ê°€ì ¸ì˜¤ëŠ”ì§€ì— ëŒ€í•´ì„œëŠ” ì „í˜€ ì‹ ê²½ ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.
- ğŸŒ• ì•ìœ¼ë¡œ ìœ ì—°í•˜ê³  íš¨ê³¼ì ì¸ ë°©ë²•ì„ ì‚¬ìš©í•´ SQL ì„œë¹„ìŠ¤ë¥¼ ë°œì „ì‹œì¼œë‚˜ê°ˆ ìˆ˜ ìˆë‹¤.
