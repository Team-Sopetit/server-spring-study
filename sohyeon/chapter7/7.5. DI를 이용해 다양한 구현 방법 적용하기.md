# 7.5 DIë¥¼ ì´ìš©í•´ ë‹¤ì–‘í•œ êµ¬í˜„ ë°©ë²• ì ìš©í•˜ê¸°
- DIì™€ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ êµ¬í˜„ì„ ë§Œë“¤ì–´ ì ìš©í•´ë³¸ë‹¤.

<br/>

## 7.5.1 ConcurrentHashMapì„ ì´ìš©í•œ ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬
- ë™ê¸°í™”ëœ í•´ì‹œ ë°ì´í„° ì¡°ì‘ì— ìµœì í™”ë˜ë„ë¡ ë§Œë“¤ì–´ì¡Œë‹¤.
- ë°ì´í„° ì¡°ì‘ ì‹œ ì „ì²´ ë°ì´í„°ì— ëŒ€í•´ ë½ì„ ê±¸ì§€ ì•Šê³  ì¡°íšŒëŠ” ë½ì„ ì•„ì˜ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ğŸ‘ ì–´ëŠ ì •ë„ ì•ˆì „í•˜ë©´ì„œ ì„±ëŠ¥ì´ ë³´ì¥ëœë‹¤.

<br/>

### ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸

```java
public class ConcurrentHashMapSqlRegistryTest {
	UpdatableSqlRegistry sqlRegistry;
	
	@BeforeEach
	public void setUp() {
		sqlRegistry = new ConcurrentHashMapSqlRegistry();
		sqlRegistry.registerSql("KEY1", "SQL1");
		sqlRegistry.registerSql("KEY2", "SQL2");
		sqlRegistry.registerSql("KEY3", "SQL3");
	}
	
	@Test
	public void find() {
		checkFindResult("SQL1", "SQL2", "SQL3");
	}
	
	// ë°˜ë³µì ìœ¼ë¡œ ê²€ì¦í•˜ëŠ” ë¶€ë¶„ì€ ë³„ë„ì˜ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•´ë‘ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ê¹”ë”í•´ì§„ë‹¤.
	private void checkFindResult(String expected1, String expected2, String expected3) {
		assertThat(sqlRegistry.findSql("KEY1"), is(expected1));
		assertThat(sqlRegistry.findSql("KEY2"), is(expected2));
		assertThat(sqlRegistry.findSql("KEY3"), is(expected3));
	}
	
	// ì£¼ì–´ì§„ í‚¤ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
	// ì˜ˆì™¸ìƒí™©ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ëŠ” ë¹¼ë¨¹ê¸°ê°€ ì‰½ê¸° ë•Œë¬¸ì— í•­ìƒ ì˜ì‹ì ìœ¼ë¡œ ë„£ìœ¼ë ¤ê³  ë…¸ë ¥í•´ì•¼ í•œë‹¤.
	@Test(expected = SqlNotFoundException.class)
	public void unknownKey() {
		sqlRegistry.findSql("SQL9999!!@#$");
	}
	
	// í•˜ë‚˜ì˜ SQLì„ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸
	// ê²€ì¦í•  ë•ŒëŠ” ë³€ê²½ëœ SQL ì™¸ì˜ ë‚˜ë¨¸ì§€ SQLì€ ê·¸ëŒ€ë¡œì¸ì§€ë„ í™•ì¸í•´ì£¼ëŠ” ê²Œ ì¢‹ë‹¤.
	@Test
	public void updateSingle() {
		sqlRegistry.updateSql("KEY2", "Modified2");
		checkFindResult("SQL1", "Modified2", "SQL3");
	}
	
	@Test
	public void updateMulti() { // í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ SQLì„ ìˆ˜ì •í•˜ëŠ” ê¸°ëŠ¥ì„ ê²€ì¦í•œë‹¤.
		Map<String, String> sqlmap = new HashMap<>();
		sqlmap.put("KEY1", "Modified1");
		sqlmap.put("KEY3", "Modified3");
		
		sqlRegistry.updateSql(sqlmap);
		checkFindResult("Modified1", "SQL2", "Modified3");
	}
	
	@Test(expected = SqlUpdatableFailureException.class) // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‚¤ì˜ SQLì„ ë³€ê²½í•˜ë ¤ê³  ì‹œë„í•  ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ê²€ì¦
	public void updateWithNotExistingKey() {
		sqlRegistry.updateSql("SQL9999!@#$", "Modified2");
	}
}
```
ğŸ”¼ ConcurrentHashMapì„ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸
- í…ŒìŠ¤íŠ¸ë¥¼ ì² ì €í•˜ê²Œ ë§Œë“¤ì–´ì„œ ê¸°ëŠ¥ì„ ê²€ì¦í•˜ê³  êµ¬í˜„ ë°©ì‹ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì„œ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¼ì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.

<br/>

### ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬í˜„
```java
public class ConcurrentHashMapSqlRegistry implements UpdatableSqlRegistry {
	
	private Map<String, String> sqlMap = new ConcurrentHashMap<>();

	@Override
	public String findSql(String key) throws SqlNotFoundException {
		String sql = sqlMap.get(key);
		if (sql == null)
			throw new SqlNotFoundException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		else
			return sql;
	}

	@Override
	public void registerSql(String key, String sql) {
		sqlMap.put(key, sql);
	}

	@Override
	public void updateSql(String key, String sql) throws SqlUpdatableFailureException {
		if (sqlMap.get(key) == null)
			throw new SqlUpdatableFailureException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		
		sqlMap.put(key, sql);
	}

	@Override
	public void updateSql(Map<String, String> sqlmap) throws SqlUpdatableFailureException {
		for (Map.Entry<String, String> entry : sqlmap.entrySet()) {
			updateSql(entry.getKey(), entry.getValue());
		}
	}
}
```
ğŸ”¼ ConcurrentHashMapì„ ì‚¬ìš©í•˜ëŠ” SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬
- ê¸°ì¡´ HashMapSqlRegistryì—ì„œ HashMapì„ ConcurrentHashMapìœ¼ë¡œ ë³€ê²½í•˜ê³ , UpdatableSqlRegistryì— ì¶”ê°€ëœ ë©”ì„œë“œë¥¼ êµ¬í˜„í•œë‹¤.

<br/>

<img width="625" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/ed3668dd-ed95-4a16-90ac-7c299d78a9d8">

ğŸ”¼ ConcurrentHashMapSqlRegistryë¥¼ ì ìš©í•œ ì„¤ì •
- XML ì„¤ì • ë³€ê²½ í›„ UserDaoTestë¥¼ ì‹¤í–‰í•´ë³´ë©´ ìƒˆë¡œ ì ìš©í•œ ConcurrentHashMapSqlRegistryê°€ OxmSqlServiceì™€ í˜‘ë ¥í•´ì„œ ê¸°ë³¸ì ì¸ SqlService ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë° ì´ìƒì´ ì—†ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br/>

## 7.5.2 ë‚´ì¥í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë§Œë“¤ê¸°
