# 7.5 DIë¥¼ ì´ìš©í•´ ë‹¤ì–‘í•œ êµ¬í˜„ ë°©ë²• ì ìš©í•˜ê¸°
- DIì™€ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ êµ¬í˜„ì„ ë§Œë“¤ì–´ ì ìš©í•´ë³¸ë‹¤.

<br/>

## 7.5.1 ConcurrentHashMapì„ ì´ìš©í•œ ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬
- ë™ê¸°í™”ëœ í•´ì‹œ ë°ì´í„° ì¡°ì‘ì— ìµœì í™”ë˜ë„ë¡ ë§Œë“¤ì–´ì¡Œë‹¤.
- ë°ì´í„° ì¡°ì‘ ì‹œ ì „ì²´ ë°ì´í„°ì— ëŒ€í•´ ë½ì„ ê±¸ì§€ ì•Šê³  ì¡°íšŒëŠ” ë½ì„ ì•„ì˜ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ğŸ‘ ì–´ëŠ ì •ë„ ì•ˆì „í•˜ë©´ì„œ ì„±ëŠ¥ì´ ë³´ì¥ëœë‹¤.

<br/>

### ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸

```java
public class ConcurrentHashMapSqlRegistryTest {
	UpdatableSqlRegistry sqlRegistry;
	
	@BeforeEach
	public void setUp() {
		sqlRegistry = new ConcurrentHashMapSqlRegistry();
		sqlRegistry.registerSql("KEY1", "SQL1");
		sqlRegistry.registerSql("KEY2", "SQL2");
		sqlRegistry.registerSql("KEY3", "SQL3");
	}
	
	@Test
	public void find() {
		checkFindResult("SQL1", "SQL2", "SQL3");
	}
	
	// ë°˜ë³µì ìœ¼ë¡œ ê²€ì¦í•˜ëŠ” ë¶€ë¶„ì€ ë³„ë„ì˜ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•´ë‘ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ê¹”ë”í•´ì§„ë‹¤.
	private void checkFindResult(String expected1, String expected2, String expected3) {
		assertThat(sqlRegistry.findSql("KEY1"), is(expected1));
		assertThat(sqlRegistry.findSql("KEY2"), is(expected2));
		assertThat(sqlRegistry.findSql("KEY3"), is(expected3));
	}
	
	// ì£¼ì–´ì§„ í‚¤ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
	// ì˜ˆì™¸ìƒí™©ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ëŠ” ë¹¼ë¨¹ê¸°ê°€ ì‰½ê¸° ë•Œë¬¸ì— í•­ìƒ ì˜ì‹ì ìœ¼ë¡œ ë„£ìœ¼ë ¤ê³  ë…¸ë ¥í•´ì•¼ í•œë‹¤.
	@Test(expected = SqlNotFoundException.class)
	public void unknownKey() {
		sqlRegistry.findSql("SQL9999!!@#$");
	}
	
	// í•˜ë‚˜ì˜ SQLì„ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸
	// ê²€ì¦í•  ë•ŒëŠ” ë³€ê²½ëœ SQL ì™¸ì˜ ë‚˜ë¨¸ì§€ SQLì€ ê·¸ëŒ€ë¡œì¸ì§€ë„ í™•ì¸í•´ì£¼ëŠ” ê²Œ ì¢‹ë‹¤.
	@Test
	public void updateSingle() {
		sqlRegistry.updateSql("KEY2", "Modified2");
		checkFindResult("SQL1", "Modified2", "SQL3");
	}
	
	@Test
	public void updateMulti() { // í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ SQLì„ ìˆ˜ì •í•˜ëŠ” ê¸°ëŠ¥ì„ ê²€ì¦í•œë‹¤.
		Map<String, String> sqlmap = new HashMap<>();
		sqlmap.put("KEY1", "Modified1");
		sqlmap.put("KEY3", "Modified3");
		
		sqlRegistry.updateSql(sqlmap);
		checkFindResult("Modified1", "SQL2", "Modified3");
	}
	
	@Test(expected = SqlUpdatableFailureException.class) // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‚¤ì˜ SQLì„ ë³€ê²½í•˜ë ¤ê³  ì‹œë„í•  ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ê²€ì¦
	public void updateWithNotExistingKey() {
		sqlRegistry.updateSql("SQL9999!@#$", "Modified2");
	}
}
```
ğŸ”¼ ConcurrentHashMapì„ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸
- í…ŒìŠ¤íŠ¸ë¥¼ ì² ì €í•˜ê²Œ ë§Œë“¤ì–´ì„œ ê¸°ëŠ¥ì„ ê²€ì¦í•˜ê³  êµ¬í˜„ ë°©ì‹ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì„œ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¼ì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤.

<br/>

### ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬í˜„
```java
public class ConcurrentHashMapSqlRegistry implements UpdatableSqlRegistry {
	
	private Map<String, String> sqlMap = new ConcurrentHashMap<>();

	@Override
	public String findSql(String key) throws SqlNotFoundException {
		String sql = sqlMap.get(key);
		if (sql == null)
			throw new SqlNotFoundException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		else
			return sql;
	}

	@Override
	public void registerSql(String key, String sql) {
		sqlMap.put(key, sql);
	}

	@Override
	public void updateSql(String key, String sql) throws SqlUpdatableFailureException {
		if (sqlMap.get(key) == null)
			throw new SqlUpdatableFailureException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		
		sqlMap.put(key, sql);
	}

	@Override
	public void updateSql(Map<String, String> sqlmap) throws SqlUpdatableFailureException {
		for (Map.Entry<String, String> entry : sqlmap.entrySet()) {
			updateSql(entry.getKey(), entry.getValue());
		}
	}
}
```
ğŸ”¼ ConcurrentHashMapì„ ì‚¬ìš©í•˜ëŠ” SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬
- ê¸°ì¡´ HashMapSqlRegistryì—ì„œ HashMapì„ ConcurrentHashMapìœ¼ë¡œ ë³€ê²½í•˜ê³ , UpdatableSqlRegistryì— ì¶”ê°€ëœ ë©”ì„œë“œë¥¼ êµ¬í˜„í•œë‹¤.

<br/>

<img width="625" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/ed3668dd-ed95-4a16-90ac-7c299d78a9d8">

ğŸ”¼ ConcurrentHashMapSqlRegistryë¥¼ ì ìš©í•œ ì„¤ì •
- XML ì„¤ì • ë³€ê²½ í›„ UserDaoTestë¥¼ ì‹¤í–‰í•´ë³´ë©´ ìƒˆë¡œ ì ìš©í•œ ConcurrentHashMapSqlRegistryê°€ OxmSqlServiceì™€ í˜‘ë ¥í•´ì„œ ê¸°ë³¸ì ì¸ SqlService ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë° ì´ìƒì´ ì—†ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br/>

## 7.5.2 ë‚´ì¥í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë§Œë“¤ê¸°
- ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•´ SQLì„ ì €ì¥í•˜ê³  ìˆ˜ì •í•˜ë„ë¡ ë§Œë“¤ì–´ë³¸ë‹¤.

<br/>

### ìŠ¤í”„ë§ì˜ ë‚´ì¥í˜• DB ì§€ì› ê¸°ëŠ¥
- ìŠ¤í”„ë§ì€ ë‚´ì¥í˜• DBë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì‘ì—…ì„ ì§€ì›í•˜ëŠ” í¸ë¦¬í•œ ë‚´ì¥í˜• DB ë¹Œë”ë¥¼ ì œê³µí•œë‹¤.
- ë°ì´í„° ì´ˆê¸°í™”ë¥¼ ìœ„í•´ í…Œì´ë¸” ë“±ì„ ìƒì„±í•˜ê±°ë‚˜ ì´ˆê¸° ë°ì´í„°ë¥¼ ì‚½ì…í•˜ëŠ” SQLì„ ì‹¤í–‰í•´ì£¼ê¸°ë„ í•œë‹¤.
- ëª¨ë“  ì¤€ë¹„ í›„ ë‚´ì¥í˜• DBì— ëŒ€í•œ DataSource ì˜¤ë¸Œì íŠ¸ë¥¼ ëŒë ¤ì£¼ëŠ”ë°, ì´í›„ë¡œëŠ” ì¼ë°˜ì ì¸ DBì²˜ëŸ¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
- ë‚´ì¥í˜• DBëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì•ˆì—ì„œ ì§ì ‘ DB ì¢…ë£Œë¥¼ ìš”ì²­í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. (shutdown()ì´ë¼ëŠ” ë©”ì„œë“œê°€ ì¶”ê°€ëœ EmbeddedDatabase ì¸í„°í˜ì´ìŠ¤ ì œê³µ)

<br/>

### ë‚´ì¥í˜• DB ë¹Œë” í•™ìŠµ í…ŒìŠ¤íŠ¸
```
CREATE TABLE SQLMAP (
	KEY_ VARCHAR(100) PRIMARY KEY,
	SQL_ VARCHAR(100) NOT NULL
);
```
ğŸ”¼ í…Œì´ë¸” ìƒì„± SQL (schema.sql íŒŒì¼)
- KEYì™€ SQL ëª¨ë‘ ì¼ë°˜ì ìœ¼ë¡œ DBì—ì„œ í‚¤ì›Œë“œë¡œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— ê·¸ëŒ€ë¡œ í•„ë“œ ì´ë¦„ìœ¼ë¡œ ì“¸ ìˆ˜ ì—†ë‹¤.
- ìœ„ ë¬¸ì œ ë•Œë¬¸ì— ë’¤ì— _ë¥¼ ì¶”ê°€í–ˆë‹¤.

<br/>

```
INSERT INTO SQLMAP(KEY_, SQL_) values ('KEY1', 'SQL1');
INSERT INTO SQLMAP(KEY_, SQL_) values ('KEY2', 'SQL2');
```
ğŸ”¼ ì´ˆê¸° ë°ì´í„° ë“±ë¡ SQL

<br/>

```java
new EmbeddedDatabaseBuilder() // ë¹Œë” ì˜¤ë¸Œì íŠ¸ ìƒì„±
	.setType(${ë‚´ì¥í˜• DB ì¢…ë¥˜}) // EmbeddedDatabaseTypeì˜ HSQL, DERBY, H2 ì¤‘ì—ì„œ í•˜ë‚˜ë¥¼ ì„ íƒí•œë‹¤.
	.addScript(${ì´ˆê¸°í™”ì— ì‚¬ìš©í•  DB ìŠ¤í¬ë¦½íŠ¸ì˜ ë¦¬ì†ŒìŠ¤}) // í…Œì´ë¸” ìƒì„±ê³¼ ë°ì´í„° ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©í•  SQL ë¬¸ì¥ì„ ë‹´ì€ SQL ìŠ¤í¬ë¦½íŠ¸ì˜ ìœ„ì¹˜ë¥¼ ì§€ì •í•œë‹¤.
	...
	.build(); // ì£¼ì–´ì§„ ì¡°ê±´ì— ë§ëŠ” ë‚´ì¥í˜• DBë¥¼ ì¤€ë¹„í•˜ê³  ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ëª¨ë‘ ì‹¤í–‰í•œ ë’¤ ì´ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” EmbeddedDatabaseë¥¼ ëŒë ¤ì¤€ë‹¤.
```
ğŸ”¼ EmbeddedDatabaseBuilderë¥¼ ì‚¬ìš©í•˜ëŠ” ì „í˜•ì ì¸ ë°©ë²•

<br/>

```java
public class EmbeddedDbTest {
	EmbeddedDatabase db;
	SimpleJdbcTemplate template; // JdbcTemplateì„ ë” í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í™•ì¥í•œ í…œí”Œë¦¿
	
	@BeforeEach
	public void setUp() {
		db = new EmbeddedDatabaseBuilder()
				.setType(EmbeddedDatabaseType.HSQL) // ì´ˆê¸°í™” SQLì´ í˜¸í™˜ë§Œ ëœë‹¤ë©´ DB ì¢…ë¥˜ëŠ” ì–¸ì œë“ ì§€ ë°”ê¿€ ìˆ˜ ìˆë‹¤.
				.addScript("classpath:/springbook/learningtest/spring/embeddeddb/schema.sql")
				.addScript("classpath:/springbook/learningtest/spring/embeddeddb/data.sql")
				.build();
		
		template = new SimpleJdbcTemplate(db); // DataSourceë¥¼ í•„ìš”ë¡œ í•˜ëŠ” SimpleJdbcTemplateì„ ë§Œë“¤ ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
	}
	
	@AfterEach
	public void tearDown() { // ë§¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í›„ DBë¥¼ ì¢…ë£Œí•œë‹¤. ë‚´ì¥í˜• ë©”ëª¨ë¦¬ DBëŠ” ë§¤ë²ˆ ìƒˆë¡­ê²Œ DBê°€ ë§Œë“¤ì–´ì§€ê³  ì œê±°ë˜ëŠ” ìƒëª…ì£¼ê¸°ë¥¼ ê°–ëŠ”ë‹¤.
		db.shutdown();
	}
	
	@Test
	public void initData() { // ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•´ ë“±ë¡ëœ ë°ì´í„°ë¥¼ ê²€ì¦í•œë‹¤.
		assertThat(template.queryForInt("select count(*) from sqlmap"), is(2));
		
		List<Map<String, Object>> list = template.queryForList("select * from sqlmap order by key_");
		assertThat((String)list.get(0).get("key_"), is("KEY1"));
		assertThat((String)list.get(0).get("sql_"), is("SQL1"));
		assertThat((String)list.get(0).get("key_"), is("KEY2"));
		assertThat((String)list.get(0).get("sql_"), is("SQL2"));
	}
	
	@Test
	public void insert() { // ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ê³  ì´ë¥¼ í™•ì¸í•´ë³¸ë‹¤.
		template.update("insert into sqlmap(key_, sql_) values(?,?)", "KEY3", "SQL3");

		assertThat(template.queryForInt("select count(*) from sqlmap"), is(3));
	}
}
```
ğŸ”¼ ë‚´ì¥í˜• DB í•™ìŠµ í…ŒìŠ¤íŠ¸

<br/>

### ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•œ SqlRegistry ë§Œë“¤ê¸°
- EmbeddedDatabaseBuilderë¥¼ í™œìš©í•´ì„œ EmbeddedDatabase íƒ€ì…ì˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•´ì£¼ëŠ” íŒ©í† ë¦¬ ë¹ˆì„ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

<br/>

```xml
<jdbc:embedded-database id="embeddedDatabase" type="HSQL">
	<jdbc:script location="classpath:schema.sql"/>
</jdbc:embedded-database>
```
ğŸ”¼ HSQL ë‚´ì¥í˜• DB ì„¤ì • ì˜ˆ
- jdbc ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì„ ì–¸í•´ë‘ê³  ê°„ë‹¨í•œ ì „ìš© íƒœê·¸ë¡œ ë¹ˆì„ ì •ì˜í•´ì£¼ë©´ ë‚´ì¥í˜• DBë¥¼ ì†ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

<br/>

```java
public class EmbeddedDbSqlRegistry implements UpdatableSqlRegistry {
	SimpleJdbcTemplate jdbc;
	
	public void setDataSource(DataSource dataSource) {
		jdbc = new SimpleJdbcTemplate(dataSource); // DataSourceë¥¼ DI ë°›ì•„ì„œ SimpleJdbcTemplate í˜•íƒœë¡œ ì €ì¥í•´ë‘ê³  ì‚¬ìš©í•œë‹¤.
	}

	@Override
	public void registerSql(String key, String sql) {
		jdbc.update("insert into sqlmap(key_, sql_) values (?,?)", key, sql);
	}

	@Override
	public String findSql(String key) throws SqlNotFoundException {
		try {
			return jdbc.queryForObject("select sql_ from sqlmap where key_ = ?", String.class, key);
		} catch (EmptyResultDataAccessException e) { // ì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ í•´ë‹¹ ì˜ˆì™¸ê°€ ë°œìƒ
			throw new SqlNotFoundException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", e);
		}
	}

	@Override
	public void updateSql(String key, String sql) throws SqlUpdatableFailureException {
		// update()ëŠ” ì‹¤í–‰ê²°ê³¼ë¡œ ì˜í–¥ ë°›ì€ ë ˆì½”ë“œì˜ ê°œìˆ˜ë¥¼ ë°˜í™˜í•œë‹¤.
		int affected = jdbc.update("update sqlmap set sql_ = ? where key_ = ?", sql, key);
		if (affected == 0) {
			throw new SqlUpdatableFailureException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
	}

	@Override
	public void updateSql(Map<String, String> sqlmap) throws SqlUpdatableFailureException {
		for (Map.Entry<String, String> entry : sqlmap.entrySet()) {
			updateSql(entry.getKey(), entry.getValue());
		}
	}
}
```
ğŸ”¼ ë‚´ì¥í˜• DBë¥¼ ì‚¬ìš©í•˜ëŠ” SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬
- ì‚¬ìš©í•˜ì§€ë„ ì•Šì„ DB ì¢…ë£Œ ê¸°ëŠ¥ì„ ê°€ì§„ EmbeddedDatabase ëŒ€ì‹  DataSource ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.

<br/>

### UpdatableSqlRegistry í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ì¬ì‚¬ìš©
- ê¸°ì¡´ì— ë§Œë“¤ì—ˆë˜ ConcurrentHashMapSqlRegistryTestì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ê³µìœ í•˜ë©´ ì¢‹ë‹¤. (ì¤‘ë³µ ë‚´ìš© ì¡´ì¬)
  - ìƒì†ì„ í™œìš©í•œë‹¤.
- ConcurrentHashMapSqlRegistryTestì˜ ì½”ë“œ ì¤‘ ConcurrentHashMapSqlRegistryì— ì§ì ‘ ì˜ì¡´í•˜ëŠ” ì½”ë“œëŠ” ë”± í•œ ì¤„ì´ë‹¤. (setUp ë¶€ë¶„)

<br/>

```java
public abstract class AbstractUpdatableSqlRegistryTest {
	UpdatableSqlRegistry sqlRegistry;

	@BeforeEach
	public void setUp() {
		sqlRegistry = createUpdatableSqlRegistry();
		sqlRegistry.registerSql("KEY1", "SQL1");
		sqlRegistry.registerSql("KEY2", "SQL2");
		sqlRegistry.registerSql("KEY3", "SQL3");
	}
	
	// í…ŒìŠ¤íŠ¸ í”½ìŠ¤ì²˜ë¥¼ ìƒì„±í•˜ëŠ” ë¶€ë¶„ë§Œ ì¶”ìƒ ë©”ì„œë“œë¡œ ë§Œë“¤ì–´ ë‘ê³  ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì´ë¥¼ êµ¬í˜„í•˜ë„ë¡ ë§Œë“ ë‹¤.
	abstract protected UpdatableSqlRegistry createUpdatableSqlRegistry();

	// ì„œë¸Œí´ë˜ìŠ¤ì— í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•œë‹¤ë©´ í•„ìš”í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ protectedë¡œ ë³€ê²½í•œë‹¤.
	protected void checkFindResult(String expected1, String expected2, String expected3) {
		...
	}

	@Test
	public void find() {
		...
	}

	// ë‚˜ë¨¸ì§€ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ëª¨ë‘ ìƒëµ
}

```
ğŸ”¼ UpdatableSqlRegistryì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¶”ìƒ í´ë˜ìŠ¤
- ë°”ë€ŒëŠ” ë¶€ë¶„ì„ ë³„ë„ì˜ ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ê³ , ì•„ì˜ˆ ì¶”ìƒ ë©”ì„œë“œë¡œ ì „í™˜í•œë‹¤.
- í´ë˜ìŠ¤ë¥¼ ì•„ì˜ˆ ì¶”ìƒ í´ë˜ìŠ¤ë¡œ ë°”ê¾¸ê³  ì´ë¦„ë„ ë³€ê²½í–ˆë‹¤.

<br/>

```java
public class ConcurrentHashMapSqlRegistryTest extends AbstractUpdatableSqlRegistryTest {
	
	@Override
	protected UpdatableSqlRegistry createUpdatableSqlRegistry() {
		return new ConcurrentHashMapSqlRegistry();
	}
}
```
ğŸ”¼ ë³€ê²½ëœ ConcurrentHashMapSqlRegistryTest
- AbstractUpdatableSqlRegistryTestë¥¼ ìƒì†í•´ì„œ ì¶”ìƒ ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì£¼ë©´ ëœë‹¤.

<br/>

```java
public class EmbeddedDbSqlRegistryTest extends AbstractUpdatableSqlRegistryTest {
	EmbeddedDatabase db;
	
	@Override
	protected UpdatableSqlRegistry createUpdatableSqlRegistry() {
		db = new EmbeddedDatabaseBuilder()
				.setType(EmbeddedDatabaseType.HSQL)
				.addScript("classpath:springbook/user/sqlservice/updatable/sqlRegistrySchema.sql")
				.build();

		EmbeddedDbSqlRegistry embeddedDbSqlRegistry = new EmbeddedDbSqlRegistry();
		embeddedDbSqlRegistry.setDataSource(db);
		
		return embeddedDbSqlRegistry;
	}
	
	@AfterEach
	public void tearDown() {
		db.shutdown();
	}
}
```
ğŸ”¼ EmbeddedDbSqlRegistryì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤
- SQLMAP í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” SQL ìŠ¤í¬ë¦½íŠ¸ëŠ” sqlRegistrySchema.sql íŒŒì¼ì— ì €ì¥í•´ë‘ê³  ë‚´ì¥í˜• DB ë¹Œë”ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- ì´ˆê¸°í™” ì‘ì—… ì¤‘ ìƒì„±ëœ EmbeddedDatabaseëŠ” ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ì €ì¥í–ˆë‹¤ê°€ @After ë©”ì„œë“œì—ì„œ DBë¥¼ ì¤‘ì§€ì‹œí‚¬ ë•Œ ì‚¬ìš©í•œë‹¤.

<br/>

### XML ì„¤ì •ì„ í†µí•œ ë‚´ì¥í˜• DBì˜ ìƒì„±ê³¼ ì ìš©

<img width="634" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/67be5858-795b-4964-b47b-f9ed702b4f05">

ğŸ”¼ jdbc ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„ ì–¸
- jdbc ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ìŠ¤í‚¤ë§ˆ ìœ„ì¹˜ ì„ ì–¸ì„ í•´ì¤€ë‹¤.

<br/>

<img width="628" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/5ae42ea0-b68c-4f3d-aa84-df4c8ffec75a">

ğŸ”¼ ë‚´ì¥í˜• DB ë“±ë¡
- íƒœê·¸ë¥¼ ì´ìš©í•´ ë‚´ì¥í˜• DBë¥¼ ë“±ë¡í•œë‹¤.
- ì´ˆê¸°í™” ì¤‘ì— í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ <jdbc:script>ë¡œ ì§€ì •í•´ì¤€ë‹¤.

<br/>

<img width="636" alt="image" src="https://github.com/Team-Sopetit/server-spring-study/assets/55437339/25aad303-40b6-4255-b29b-654a967ad288">

ğŸ”¼ EmbeddedDbSqlRegistry í´ë˜ìŠ¤ë¥¼ ì´ìš©í•œ ë¹ˆ ë“±ë¡
- embeddedDatabase ë¹ˆì„ dataSource í”„ë¡œí¼í‹°ë¡œ ì°¸ì¡°í•˜ëŠ” EmbeddedDbSqlRegistry íƒ€ì…ì˜ sqlRegistry ë¹ˆì„ ì •ì˜í•´ì¤€ë‹¤.

<br/>

## 7.5.3 íŠ¸ëœì­ì…˜ ì ìš©
- ì—¬ëŸ¬ ê°œì˜ SQLì„ ìˆ˜ì •í•˜ëŠ” ì‘ì—…ì€ ë°˜ë“œì‹œ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì¼ì–´ë‚˜ì•¼ í•œë‹¤.
- ë‚´ì¥í˜• DBë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ëŠ” DB ìì²´ê°€ ê¸°ë³¸ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ê¸°ë°˜ì˜ ì‘ì—…ì— ì¶©ì‹¤í•˜ê²Œ ì„¤ê³„ëê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ì ìš©ì´ ìƒëŒ€ì ìœ¼ë¡œ ì‰½ë‹¤.

<br/>

### ë‹¤ì¤‘ SQL ìˆ˜ì •ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸
- íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì ê²€í•˜ëŠ” ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ë©”ì„œë“œë¥¼ EmbeddedDbSqlRegistryTest í´ë˜ìŠ¤ì— ì¶”ê°€í•œë‹¤.

<br/>

```java
public class EmbeddedDbSqlRegistryTest extends AbstractUpdatableSqlRegistryTest {
	...
	
	@Test
	public void transactionalUpdate() {
		checkFindResult("SQL1", "SQL2", "SQL3"); // ì´ˆê¸° ìƒíƒœë¥¼ í™•ì¸í•œë‹¤.

		Map<String, String> sqlmap = new HashMap<>();
		sqlmap.put("KEY1", "Modified1");
		sqlmap.put("KEY9999!@#$", "Modified"); // ë‘ë²ˆì§¸ SQLì˜ í‚¤ë¥¼ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ ì§€ì •í•œë‹¤.
		
		try {
			sqlRegistry.updateSql(sqlmap);
			fail(); // ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ catch ë¸”ë¡ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨í•œ ê²ƒì´ë‹¤.
		} catch (SqlUpdatableFailureException e) {}
		
		checkFindResult("SQL1", "SQL2", "SQL3"); // íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ëê¸° ë•Œë¬¸ì— ì²˜ìŒ ìƒíƒœì™€ ê°™ì•„ì•¼ í•œë‹¤.
	}
}
```
ğŸ”¼ ë‹¤ì¤‘ SQL ìˆ˜ì •ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸
- ì•„ì§ ë‹¤ì¤‘ SQL ìˆ˜ì • ì½”ë“œì— íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ëª©ì ì´ë‹¤.

<br/>

### ì½”ë“œë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ì ìš©
- íŠ¸ëœì­ì…˜ ì ìš© ì½”ë“œì— í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì„ ì ìš©í•œ TransactionTemplateì„ ì‚¬ìš©í•œë‹¤.
- EmbeddedDbSqlRegistry ë‚´ë¶€ì—ì„œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ ì‚¬ìš©í•œë‹¤.

<br/>

```java
public class EmbeddedDbSqlRegistry implements UpdatableSqlRegistry {
	SimpleJdbcTemplate jdbc;
	TransactionTemplate transactionTemplate; // JdbcTemplateê³¼ íŠ¸ëœì­ì…˜ì„ ë™ê¸°í™”í•´ì£¼ëŠ” íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ìœ¼ë¡œ, ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ê³µìœ  ê°€ëŠ¥í•˜ë‹¤.

	public void setDataSource(DataSource dataSource) {
		jdbc = new SimpleJdbcTemplate(dataSource);

		// dataSourceë¡œ TransactionManagerë¥¼ ë§Œë“¤ê³  ì´ë¥¼ ì´ìš©í•´ TransactionTemplateì„ ìƒì„±í•œë‹¤.
		transactionTemplate = new TransactionTemplate(new DataSourceTransactionManager(dataSource));
	}

	...

	@Override
	public void updateSql(final Map<String, String> sqlmap) throws SqlUpdatableFailureException {
		transactionTemplate.execute(new TransactionCallbackWithoutResult() {
			@Override
			protected void doInTransactionWithoutResult(TransactionStatus status) { // íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì´ ë§Œë“œëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì•ˆì—ì„œ ë™ì‘í•  ì½”ë“œë¥¼ ì½œë°± í˜•íƒœë¡œ ë§Œë“¤ê³  TransactionTemplateì˜ execute() ë©”ì„œë“œì— ì „ë‹¬í•œë‹¤.
				for (Map.Entry<String, String> entry : sqlmap.entrySet()) {
					updateSql(entry.getKey(), entry.getValue());
				}
			}
		});
	}
}
```
ğŸ”¼ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ê°€ì§„ EmbeddedDbSqlRegistry
- sqlmapì€ ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§€ëŠ” ì½œë°± ì˜¤ë¸Œì íŠ¸ ì•ˆì—ì„œ ì‚¬ìš©ë˜ëŠ” ê²ƒì´ë¼ finalë¡œ ì„ ì–¸í•´ì¤€ë‹¤.
- íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ì„ ì´ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì ìš©í–ˆë‹¤.
