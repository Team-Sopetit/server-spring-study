# 7.3 서비스 추상화 적용
- 자바에는 JAXB 외에도 다양한 XML과 자바 오브젝트를 매핑하는 기술이 있다. 필요에 따라 다른 기술로 손쉽게 바꿔서 사용할 수 있게 해야 한다.
- XML 파일을 좀 더 다양한 소스에서 가져올 수 있게 만든다. 현재는 UserDao 클래스와 같은 클래스패스 안에서만 XML을 읽어올 수 있다. 이것을 임의의 클래스패스나 파일 시스템 상의 절대 위치 또는 HTTP 프로토콜을 통해 원격에서 가져오도록 확장할 수는 없는가 하는 점이다.

<br/>

## 7.3.1 OXM(Object XML Mapping) 서비스 추상화
- JAXB 외에 실전에서 자주 사용되는 XML과 자바 오브젝트 매핑 기술이 있다.
  - Castor XML: 매우 간결하고 가벼운 바인딩 프레임워크(설정파일X, 인트로스펙션 모드 지원)
  - JiBX: 뛰어난 퍼포먼스를 가진 XML 바인딩 기술
  - XmlBeans: 아파치 XML 프로젝트 중 하나 (XML의 정보셋을 효과적으로 제공)
  - Xstream: 관계를 이용해서 설정 없는 바인딩을 지원하는 XML 바인딩 기술 중 하나
- 서비스 추상화가 필요하다.
  - 추상화된 레이어와 API를 제공해서 구현 기술에 대해 독립적인 코드를 작성할 수 있게 한다.
  - 테스트 작성도 편하다.

<br/>

### OXM 서비스 인터페이스
- **Marshaller**: 자바 오브젝트를 XML로 변환
- **Unmarshaller**: XML을 자바 오브젝트로 변환
  - SqlReader가 이용

<br/>

```java
...
import javax.xml.transform.Source;
...
public interface Unmarshaller {

	// 해당 클래스로 언마샬이 가능한지 확인해준다.
	// 별로 사용할 일은 없다.
	boolean supports(Class<?> clazz);
	
	// source를 통해 제공받은 XML을 자바 오브젝트 트리로 변환해서 그 루트 오브젝트를 돌려준다.
	// XmlMappingException: 매핑 실패 시 추상화된 예외를 던진다. 서브클래스에 좀 더 세분화되어 있다.
	Object unmarshal(Source source) throws IOException, XmlMappingException;
}
```
🔼 Unmarshaller 인터페이스
- XML 파일에 대한 정보를 담은 Source 타입의 오브젝트를 주면, OXM 기술을 통해 자바오브젝트 트리로 변환하고, 루트 오브젝트를 돌려준다.
- OXM 기술에 따라 Unmarshaller 인터페이스를 구현한 5가지 클래스가 있다.

<br/>

### JAXB 구현 테스트
```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org.schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  <bean id="unmarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
    <property name="contextPath" value="springbook.user.sqlservice.jaxb" />
  </bean>
</beans>
```
🔼 JAXB용 Unmarshaller 빈 설정
- OxmTest-context.xml 파일을 만들고 JAXB 언마샬러를 등록한 빈 설정을 만들어준다.

<br/>

```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration // 클래스 이름 + '-context.xml' 파일을 사용하는 애플리케이션 컨텍스트로 만들어 테스트가 사용할 수 있게 한다.
public class OxmTest {
	
	// 스프링 테스트가 테스트용 애플리케이션 컨텍스트에서 Unmarshaller 인터페이스 타입의 빈을 찾아 테스트가 시작되기 전 해당 변수에 넣어준다.
	// 앞에서 정의한 Unmarshaller 인터페이스
	@Autowired Unmarshaller unmarshaller;
	
	@Test
	public void unmarshallSqlMap() throws XmlMappingException, IOException {
		// InputStream을 이용하는 Source 타입의 StreamSource를 만든다.
		Source xmlSource = new StreamSource(getClass().getResourceAsStream("sqlmap.xml"));

		// 어떤 OXM 기술이든 언마샬은 아래 줄이면 끝난다.
		Sqlmap sqlmap = (Sqlmap) this.unmarshaller.unmarshal(xmlSource);

		List<SqlType> sqlList = sqlmap.getSql();
		assertThat(sqlList.size(), is(3));
		
		// JaxbTest와 동일하게 sqlmap.xml 파일의 내용을 정확히 가져왔는지 검사한다.
		assertThat(sqlList.get(0).getKey(), is("add"));
		...
		assertThat(sqlList.get(2).getValue(), is("delete"));
	}
}
```
🔼 OXM 언마샬링 테스트 코드
- 미리 준비한 간단한 sqlmap.xml 파일을 읽어와 내용을 확인한다.
- JAXB라는 구체적인 기술에 의존하는 부분은 없다. (추상화 계층 이용)
  - OXM 기술을 JAXB가 아닌 다른 것으로 바꿔도 테스트 코드는 전혀 수정할 것이 없다.
  - XML의 빈 설정만 변경해주면 된다.
 
<br/>

### Castor 구현 테스트
- OXM 기술을 Castor로 바꿔본다.
- 빈 설정만 바꿔주면 된다.

<br/>

```xml
<?xml version="1.0"?>
<!DOCTYPE mapping PUBLIC "-//EXOLAB/Castor Mapping DTO Version 1.0//EN" "http://castor.org/mapping.dtd">
<mapping>
    <class name="com.example.tobyspringexperience.jaxb.Sqlmap">
        <map-to xml="sqlmap" />
        <field name="sql" type="com.example.tobyspringexperience.jaxb.SqlType" required="true" collection="arraylist">
            <bind-xml name="sql" node="element" />
        </field>
    </class>
    <class name="com.example.tobyspringexperience.jaxb.SqlType">
        <map-to xml="sql" />
        <field name="key" type="string" required="true">
            <bind-xml name="key" node="attribute" />
        </field>
        <field name="value" type="string" required="true">
            <bind-xml node="text" />
        </field>
    </class>
</mapping>
```
🔼 Castor용 매핑정보
- Castor에서 사용할 매핑정보를 담은 XML을 만들었다.

<br/>

```xml
<bean id="unmarshaller" class="org.springframework.oxm.castor.CastorMarshaller"> <!-- Unmarshaller 인터페이스를 Castor API를 이용해서 구현한 클래스 -->
  <property name="mappingLocation" value="springbook/learningtest/spring/oxm/mapping.xml" />
</bean>
```
🔼 Castor 기술을 사용하는 언마샬러 설정
- 설정파일의 unmarshaller 빈의 클래스를 Castor용 구현 클래스로 변경한다.
- mappingLocation 프로퍼티에는 준비된 Castor용 매핑파일의 위치를 지정한다.
- 테스트 코드를 실행해보면 별 다른 변경 없이도 성공할 것이다. (추상화 계층을 사용했기 때문)

<br/>

## 7.3.2 OXM 서비스 추상화 적용
